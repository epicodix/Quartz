---
title: 08_02_ì¿ ë²„ë„¤í‹°ìŠ¤_ë³´ì•ˆê³¼_ìì›ê´€ë¦¬
tags:
  - kubernetes
  - security
  - rbac
  - resourcequota
  - limitrange
  - networkpolicy
  - devops
  - infrastructure
aliases:
  - k8s-security
  - ì¿ ë²„ë„¤í‹°ìŠ¤-ë³´ì•ˆ
date: 2025-11-26
category: êµìœ¡/êµ¬ë¦„ë”¥ë‹¤ì´ë¸Œ
status: ì™„ì„±
priority: ë†’ìŒ
---
 
# ğŸ¯ 8ì¥ - ì¿ ë²„ë„¤í‹°ìŠ¤ ë³´ì•ˆê³¼ ìì›ê´€ë¦¬

## ğŸ“‘ ëª©ì°¨
- [[#1. RBAC (Role-Based Access Control)|1. RBAC]]
- [[#2. ResourceQuota - ì‹œìŠ¤í…œ ìì› ì‚¬ìš© ê´€ë¦¬|2. ResourceQuota]]
- [[#3. LimitRange - ë¦¬ì†ŒìŠ¤ ì œí•œ ì •ì±…|3. LimitRange]]  
- [[#4. NetworkPolicy - ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ|4. NetworkPolicy]]
- [[#ğŸ¯ ì‹¤ì „ ì˜ˆì‹œ|ì‹¤ì „ ì˜ˆì‹œ]]

---

## 1. RBAC (Role-Based Access Control): ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´

> [!note] ì´ì „ ê°•ì˜ ë³µìŠµ
> RBACëŠ” 08_01ì—ì„œ ìì„¸íˆ ë‹¤ë¤˜ìŠµë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” í•µì‹¬ êµ¬ì„±ìš”ì†Œë§Œ ê°„ëµíˆ ì •ë¦¬í•©ë‹ˆë‹¤.

### ğŸ“‹ RBAC êµ¬ì„±ìš”ì†Œ ìš”ì•½

| êµ¬ì„±ìš”ì†Œ                   | ì—­í•                   | ìŠ¤ì½”í”„    |
| ---------------------- | ------------------- | ------ |
| **Role**               | íŠ¹ì • ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë‚´ ê¶Œí•œ ì •ì˜   | ë„¤ì„ìŠ¤í˜ì´ìŠ¤ |
| **ClusterRole**        | í´ëŸ¬ìŠ¤í„° ì „ì²´ ê¶Œí•œ ì •ì˜       | í´ëŸ¬ìŠ¤í„°   |
| **RoleBinding**        | Roleê³¼ ì‚¬ìš©ì ì—°ê²°        | ë„¤ì„ìŠ¤í˜ì´ìŠ¤ |
| **ClusterRoleBinding** | ClusterRoleê³¼ ì‚¬ìš©ì ì—°ê²° | í´ëŸ¬ìŠ¤í„°   |

#### âœ… ì‹¤ìŠµ ê²°ê³¼ í™•ì¸
- dev1-hoon: `get, list` ê¶Œí•œë§Œ ë³´ìœ  âœ…
- dev2-moon: `get, create, delete` ê¶Œí•œ ë³´ìœ  âœ…
- í¬ë¡œìŠ¤ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì ‘ê·¼ ì°¨ë‹¨ âœ…

---

## 2. ResourceQuota - ì‹œìŠ¤í…œ ìì› ì‚¬ìš© ê´€ë¦¬

> [!info] í•µì‹¬ ëª©ì 
> ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„ë¡œ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ì„ ì œí•œí•˜ì—¬ ë©€í‹°í…Œë„ŒíŠ¸ í™˜ê²½ì—ì„œ ê³µì •í•œ ìì› ë¶„ë°°ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤. **"í•œ íŒ€ì´ ëª¨ë“  ë¦¬ì†ŒìŠ¤ë¥¼ ë…ì í•˜ì§€ ëª»í•˜ê²Œ í•˜ëŠ” ê²ƒ"**ì´ í•µì‹¬ì…ë‹ˆë‹¤.

### ğŸ¤” ì™œ ResourceQuotaê°€ í•„ìš”í•œê°€?

#### ğŸ“‹ ë¬¸ì œ ìƒí™© ì˜ˆì‹œ
```
ì‹œë‚˜ë¦¬ì˜¤: íšŒì‚¬ì—ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ í´ëŸ¬ìŠ¤í„° í•˜ë‚˜ë¥¼ ì—¬ëŸ¬ íŒ€ì´ ê³µìœ 
- ê°œë°œíŒ€ A: ëŒ€ìš©ëŸ‰ ML ëª¨ë¸ í•™ìŠµ (CPU 16ì½”ì–´, RAM 64GB ìš”êµ¬)
- ê°œë°œíŒ€ B: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ê°œë°œ (CPU 2ì½”ì–´, RAM 4GBë©´ ì¶©ë¶„)
- ê°œë°œíŒ€ C: ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í…ŒìŠ¤íŠ¸ (ì—¬ëŸ¬ ê°œì˜ ì‘ì€ Podë“¤)

ë¬¸ì œ: íŒ€ Aê°€ ML í•™ìŠµì„ ì‹œì‘í•˜ë©´ â†’ í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ ëª¨ë‘ ì†Œì§„ â†’ íŒ€ B, C ì‘ì—… ë¶ˆê°€
```

### ğŸ’¡ ResourceQuota ë™ì‘ ì›ë¦¬

#### ğŸ” **í• ë‹¹ëŸ‰ vs ì‚¬ìš©ëŸ‰ ê°œë…**

> [!example] ì‹¤ìƒí™œ ë¹„ìœ 
> - **í• ë‹¹ëŸ‰(Hard Limit)**: ì€í–‰ ê³„ì¢Œì˜ "ì‹ ìš©ì¹´ë“œ í•œë„"
> - **ì‚¬ìš©ëŸ‰(Used)**: í˜„ì¬ê¹Œì§€ "ì‚¬ìš©í•œ ê¸ˆì•¡"
> - **ë‚¨ì€ í• ë‹¹ëŸ‰**: "ì•„ì§ ì“¸ ìˆ˜ ìˆëŠ” ê¸ˆì•¡"

```yaml
# ğŸ“Š ResourceQuota ìƒì„¸ ì„¤ì •
apiVersion: v1
kind: ResourceQuota
metadata:
  name: quota-dev1
  namespace: dev1
spec:
  hard:
    # 1. ê°ì²´ ê°œìˆ˜ ì œí•œ
    pods: "10"                          # ìµœëŒ€ Pod 10ê°œ
    persistentvolumeclaims: "2"         # ìµœëŒ€ PVC 2ê°œ
    services: "5"                       # ìµœëŒ€ Service 5ê°œ
    secrets: "10"                       # ìµœëŒ€ Secret 10ê°œ
    configmaps: "10"                    # ìµœëŒ€ ConfigMap 10ê°œ
    
    # 2. ì»´í“¨íŒ… ë¦¬ì†ŒìŠ¤ ì œí•œ
    requests.cpu: "4"                   # CPU ìš”ì²­ ì´í•© 4ì½”ì–´
    requests.memory: "8Gi"              # ë©”ëª¨ë¦¬ ìš”ì²­ ì´í•© 8GB
    limits.cpu: "8"                     # CPU ì œí•œ ì´í•© 8ì½”ì–´
    limits.memory: "16Gi"               # ë©”ëª¨ë¦¬ ì œí•œ ì´í•© 16GB
    
    # 3. ìŠ¤í† ë¦¬ì§€ ë¦¬ì†ŒìŠ¤ ì œí•œ
    requests.storage: "50Gi"            # ìŠ¤í† ë¦¬ì§€ ìš”ì²­ ì´í•© 50GB
    persistentvolumeclaims: "5"         # PVC ê°œìˆ˜ ì œí•œ
    
    # 4. íŠ¹ì • ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ì œí•œ
    requests.nvidia.com/gpu: "2"        # GPU ê°œìˆ˜ ì œí•œ
```

### ğŸ’» ResourceQuota ì ìš© ê³¼ì • ë¶„ì„

#### ğŸ“Š ë‹¨ê³„ë³„ ì ìš© ê²°ê³¼ í™•ì¸

```bash
# 1. ì´ˆê¸° ìƒíƒœ (ì•„ë¬´ê²ƒë„ ì—†ìŒ)
kubectl describe resourcequota quota-dev1 -n dev1
```

```
Name:                   quota-dev1
Namespace:              dev1
Resource                Used  Hard
--------                ----  ----
persistentvolumeclaims  0     2      # PVC: 0ê°œ ì‚¬ìš© / 2ê°œ í—ˆìš©
pods                    0     10     # Pod: 0ê°œ ì‚¬ìš© / 10ê°œ í—ˆìš©
requests.storage        0     2Gi    # ìŠ¤í† ë¦¬ì§€: 0GB ì‚¬ìš© / 2GB í—ˆìš©
```

#### ğŸ“Š Pod ìƒì„± í›„ ìƒíƒœ ë³€í™”

```bash
# test-pod ìƒì„± í›„
kubectl describe resourcequota quota-dev1 -n dev1
```

```
Name:                   quota-dev1
Namespace:              dev1
Resource                Used  Hard
--------                ----  ----
persistentvolumeclaims  0     2      # PVCëŠ” ì•„ì§ ìƒì„± ì•ˆí•¨
pods                    1     10     # Pod 1ê°œ ìƒì„±ë¨ (9ê°œ ë” ê°€ëŠ¥)
requests.storage        0     2Gi    # ìŠ¤í† ë¦¬ì§€ëŠ” ì•„ì§ ì‚¬ìš© ì•ˆí•¨
```

#### ğŸ“Š PVC ìƒì„± í›„ ìƒíƒœ ë³€í™”

```bash
# PVC 1ê°œ ìƒì„± í›„ (1Gi í¬ê¸°)
kubectl apply -f quota-1G-pvc1.yaml
kubectl describe resourcequota quota-dev1 -n dev1
```

```
Name:                   quota-dev1
Namespace:              dev1
Resource                Used  Hard
--------                ----  ----
persistentvolumeclaims  1     2      # PVC 1ê°œ ì‚¬ìš©ë¨ (1ê°œ ë” ê°€ëŠ¥)
pods                    1     10     # Pod 1ê°œ ì‚¬ìš© ì¤‘
requests.storage        1Gi   2Gi    # ìŠ¤í† ë¦¬ì§€ 1GB ì‚¬ìš©ë¨ (1GB ë” ê°€ëŠ¥)
```

### âš ï¸ ResourceQuota ì œí•œ ë™ì‘ í™•ì¸

#### ğŸš¨ í• ë‹¹ëŸ‰ ì´ˆê³¼ ì‹œ ì–´ë–»ê²Œ ë˜ëŠ”ê°€?

```yaml
# ğŸ“Š 2GB ì´ˆê³¼í•˜ëŠ” PVC ìƒì„± ì‹œë„
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-too-large
  namespace: dev1
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 3Gi    # í• ë‹¹ëŸ‰(2Gi) ì´ˆê³¼!
```

#### ğŸ“Š ì˜ˆìƒë˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€

```bash
kubectl apply -f pvc-too-large.yaml
```

```
Error from server (Forbidden): error when creating "pvc-too-large.yaml": 
persistentvolumeclaims "pvc-too-large" is forbidden: 
exceeded quota: quota-dev1, requested: requests.storage=3Gi, 
used: requests.storage=1Gi, limited: requests.storage=2Gi
```

> [!warning] ì—ëŸ¬ ë©”ì‹œì§€ í•´ì„
> - **ìš”ì²­í•œ ê²ƒ**: `requests.storage=3Gi`
> - **ì´ë¯¸ ì‚¬ìš© ì¤‘**: `used: requests.storage=1Gi`  
> - **ì „ì²´ í• ë‹¹ëŸ‰**: `limited: requests.storage=2Gi`
> - **ê²°ê³¼**: 1Gi + 3Gi = 4Gi > 2Gi ì´ë¯€ë¡œ ê±°ë¶€ë¨

### ğŸ’¡ ResourceQuota ê³ ê¸‰ í™œìš©

#### ğŸ“Š ìš°ì„ ìˆœìœ„ í´ë˜ìŠ¤ë³„ í• ë‹¹ëŸ‰

```yaml
# ğŸ“Š ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ ì°¨ë“± í• ë‹¹
apiVersion: v1
kind: ResourceQuota
metadata:
  name: quota-high-priority
  namespace: dev1
spec:
  hard:
    pods: "5"
    requests.cpu: "10"
    requests.memory: "20Gi"
  scopeSelector:
    matchExpressions:
    - operator: In
      scopeName: PriorityClass
      values: ["high-priority"]
---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: quota-low-priority
  namespace: dev1
spec:
  hard:
    pods: "20"
    requests.cpu: "2"
    requests.memory: "4Gi"
  scopeSelector:
    matchExpressions:
    - operator: In
      scopeName: PriorityClass
      values: ["low-priority"]
```

#### ğŸ“Š ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ëª…ë ¹ì–´

```bash
# ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ResourceQuota í™•ì¸
kubectl get resourcequota --all-namespaces

# íŠ¹ì • ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ê°ì‹œ
watch kubectl describe resourcequota quota-dev1 -n dev1

# JSON í˜•íƒœë¡œ ìƒì„¸ ì •ë³´ í™•ì¸
kubectl get resourcequota quota-dev1 -n dev1 -o json | jq '.status'
```

### ğŸ¯ ì‹¤ì „ì—ì„œì˜ ResourceQuota ì„¤ê³„

#### ğŸ¤” ì§ˆë¬¸: "íŒ€ë³„ë¡œ ì–´ë–»ê²Œ í• ë‹¹ëŸ‰ì„ ë‚˜ëˆ ì•¼ í• ê¹Œ?"

#### ğŸ“‹ í• ë‹¹ëŸ‰ ê³„ì‚° ë°©ë²•

> [!example] ì‹¤ì œ ê³„ì‚° ê³¼ì •
> **ì „ì²´ í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤**: CPU 32ì½”ì–´, RAM 128GB, Storage 1TB
> 
> **íŒ€ë³„ íŠ¹ì„± ë¶„ì„**:
> - ê°œë°œíŒ€ A (ML): ê³ ì‚¬ì–‘ í•„ìš”, ì‘ì—… ìˆ˜ ì ìŒ
> - ê°œë°œíŒ€ B (ì›¹): ì¤‘ê°„ ì‚¬ì–‘, ì—¬ëŸ¬ í™˜ê²½ í•„ìš”  
> - ê°œë°œíŒ€ C (ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤): ì €ì‚¬ì–‘, Pod ìˆ˜ ë§ìŒ
> 
> **í• ë‹¹ ì „ëµ**:
> ```yaml
> # íŒ€ A (MLíŒ€)
> requests.cpu: "12"      # ì „ì²´ì˜ 37.5%
> requests.memory: "48Gi" # ì „ì²´ì˜ 37.5%
> pods: "5"               # ì ì€ ìˆ˜ì˜ ê³ ì‚¬ì–‘ Pod
> 
> # íŒ€ B (ì›¹íŒ€) 
> requests.cpu: "8"       # ì „ì²´ì˜ 25%
> requests.memory: "32Gi" # ì „ì²´ì˜ 25%
> pods: "15"              # ì¤‘ê°„ ìˆ˜ì˜ Pod
> 
> # íŒ€ C (ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤íŒ€)
> requests.cpu: "8"       # ì „ì²´ì˜ 25%
> requests.memory: "32Gi" # ì „ì²´ì˜ 25%
> pods: "50"              # ë§ì€ ìˆ˜ì˜ ì†Œí˜• Pod
> 
> # ì‹œìŠ¤í…œ ì˜ˆì•½
> ë‚¨ì€ 12.5% = ì‹œìŠ¤í…œ Pod ë° ì˜ˆë¹„ í• ë‹¹ëŸ‰
> ```

#### ğŸ“Š ë™ì  í• ë‹¹ëŸ‰ ì¡°ì • ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# ğŸ“Š ì‚¬ìš©ë¥  ê¸°ë°˜ í• ë‹¹ëŸ‰ ëª¨ë‹ˆí„°ë§

NAMESPACE="dev1"
QUOTA_NAME="quota-dev1"

# í˜„ì¬ ì‚¬ìš©ë¥  í™•ì¸
USED_PODS=$(kubectl get resourcequota $QUOTA_NAME -n $NAMESPACE -o jsonpath='{.status.used.pods}')
HARD_PODS=$(kubectl get resourcequota $QUOTA_NAME -n $NAMESPACE -o jsonpath='{.status.hard.pods}')

USAGE_PERCENT=$((USED_PODS * 100 / HARD_PODS))

echo "Pod ì‚¬ìš©ë¥ : $USAGE_PERCENT% ($USED_PODS/$HARD_PODS)"

# 80% ì´ˆê³¼ ì‹œ ì•Œë¦¼
if [ $USAGE_PERCENT -gt 80 ]; then
    echo "âš ï¸  ê²½ê³ : Pod í• ë‹¹ëŸ‰ì´ 80%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!"
    echo "ğŸ“Š í™•ì¥ì„ ê²€í† í•´ì£¼ì„¸ìš”."
fi
```

---

**ì´ì œ ResourceQuotaê°€ ì–´ë–»ê²Œ ì‘ë™í•˜ëŠ”ì§€, ì™œ í•„ìš”í•œì§€, ì–´ë–»ê²Œ ì„¤ê³„í•´ì•¼ í•˜ëŠ”ì§€ ëª…í™•í•´ì¡Œë‚˜ìš”?** ğŸ’¡

---

## 3. LimitRange - ë¦¬ì†ŒìŠ¤ ì œí•œ ì •ì±…

> [!tip] í™œìš©ë²•
> ê°œë³„ ë¦¬ì†ŒìŠ¤ ê°ì²´ì— ëŒ€í•œ ìµœì†Œ/ìµœëŒ€ ì‚¬ìš©ëŸ‰ì„ ì„¤ì •í•˜ì—¬ ë¦¬ì†ŒìŠ¤ ë‚¨ìš©ì„ ë°©ì§€í•©ë‹ˆë‹¤.

### ğŸ’» LimitRange ì„¤ì • ì˜ˆì‹œ

```yaml
# ğŸ“Š dev1 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¦¬ì†ŒìŠ¤ ì œí•œ ì •ì±…
apiVersion: v1
kind: LimitRange
metadata:
  name: limitrange-dev1
  namespace: dev1
spec:
  limits:
  - default:              # ê¸°ë³¸ ì œí•œê°’
      memory: "512Mi"
      cpu: "500m"
    defaultRequest:       # ê¸°ë³¸ ìš”ì²­ê°’
      memory: "256Mi"
      cpu: "250m"
    type: Container
  - max:                 # ìµœëŒ€ê°’
      storage: "1Gi"
    min:                 # ìµœì†Œê°’
      storage: "100Mi"
    type: PersistentVolumeClaim
```

#### ğŸ“Š LimitRange íš¨ê³¼ í™•ì¸

Pod ìƒì„± ì‹œ ë¦¬ì†ŒìŠ¤ ëª…ì‹œë¥¼ í•˜ì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ê¸°ë³¸ê°’ì´ ì ìš©ë©ë‹ˆë‹¤:

```bash
kubectl describe pod test-pod -n dev1
```

```
Requests:
  cpu:        250m      # ê¸°ë³¸ ìš”ì²­ê°’ ìë™ ì ìš©
  memory:     256Mi     # ê¸°ë³¸ ìš”ì²­ê°’ ìë™ ì ìš©
Limits:
  cpu:        500m      # ê¸°ë³¸ ì œí•œê°’ ìë™ ì ìš©
  memory:     512Mi     # ê¸°ë³¸ ì œí•œê°’ ìë™ ì ìš©
```

---

## 4. NetworkPolicy - ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ğŸ›¡ï¸

> [!info] í•µì‹¬ ëª©ì 
> NetworkPolicyëŠ” **"Pod ê°„ì˜ ë„¤íŠ¸ì›Œí¬ í†µì‹ ì„ ì„¸ë°€í•˜ê²Œ ì œì–´"**í•˜ëŠ” ë°©í™”ë²½ ê°™ì€ ì—­í• ì„ í•©ë‹ˆë‹¤. **"ëˆ„ê°€, ì–´ë””ì„œ, ì–´ë–¤ Podì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ê°€"**ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

### ğŸ¤” ì™œ NetworkPolicyê°€ í•„ìš”í•œê°€?

#### ğŸ“‹ ë³´ì•ˆ ìœ„í—˜ ì‹œë‚˜ë¦¬ì˜¤
```
ìƒí™©: ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ í™˜ê²½
- ì›¹ í”„ë¡ íŠ¸ì—”ë“œ Pod
- API ì„œë²„ Pod  
- ë°ì´í„°ë² ì´ìŠ¤ Pod
- ê²°ì œ ì²˜ë¦¬ Pod (ë¯¼ê°í•œ ì •ë³´)

ë¬¸ì œ: ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  Podê°€ ì„œë¡œ ììœ ë¡­ê²Œ í†µì‹  ê°€ëŠ¥
â†’ ì›¹ í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì§ì ‘ ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê°€ëŠ¥ (ë³´ì•ˆ ì·¨ì•½ì )
â†’ ê³µê²©ìê°€ í•˜ë‚˜ì˜ Podë¥¼ í•´í‚¹í•˜ë©´ ëª¨ë“  Podì— ì ‘ê·¼ ê°€ëŠ¥
```

#### ğŸ¯ **NetworkPolicyì˜ í•µì‹¬ ì›ì¹™**

> [!note] ê¸°ë³¸ ë™ì‘ ë°©ì‹
> 1. **ê¸°ë³¸ ìƒíƒœ**: ëª¨ë“  íŠ¸ë˜í”½ í—ˆìš© (ê´€ëŒ€í•œ ì •ì±…)
> 2. **NetworkPolicy ì ìš©**: ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©ëœ ê²ƒë§Œ í†µì‹  (ì—„ê²©í•œ ì •ì±…)
> 3. **í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹**: í—ˆìš© ëª©ë¡ì— ìˆëŠ” ê²ƒë§Œ í†µê³¼

### ğŸ’¡ NetworkPolicy í•µì‹¬ ê°œë…

#### ğŸ” **Ingress vs Egress - ì‰¬ìš´ ì´í•´ë²•**

> [!example] ğŸ’¡ ë‚˜ì˜ ì§‘ ê´€ì ì—ì„œ ìƒê°í•´ë³´ì!
> ë‚´ê°€ **database Pod**ë¼ê³  ìƒìƒí•´ë³´ì„¸ìš”.
> 
> **Ingress (ë“¤ì–´ì˜¤ëŠ” ê²ƒ)**:
> - ë‹¤ë¥¸ Podê°€ ë‚˜(database)ì—ê²Œ ì™€ì„œ ë°ì´í„°ë¥¼ ìš”ì²­í•˜ëŠ” ê²ƒ
> - "ëˆ„ê°€ ë‚˜í•œí…Œ ì˜¬ ìˆ˜ ìˆë‚˜ìš”?"
> - API Pod â†’ ë‚˜(Database) âœ… í—ˆìš©
> - Web Pod â†’ ë‚˜(Database) âŒ ì°¨ë‹¨
> 
> **Egress (ë‚˜ê°€ëŠ” ê²ƒ)**:
> - ë‚´(database)ê°€ ë‹¤ë¥¸ ê³³ìœ¼ë¡œ ë‚˜ê°€ëŠ” ê²ƒ
> - "ë‚´ê°€ ì–´ë””ë¡œ ê°ˆ ìˆ˜ ìˆë‚˜ìš”?"
> - ë‚˜(Database) â†’ ë¡œê·¸ ì„œë²„ âœ… í—ˆìš©
> - ë‚˜(Database) â†’ ì¸í„°ë„· âŒ ì°¨ë‹¨

#### ğŸ“Š **êµ¬ì²´ì ì¸ ì˜ˆì‹œë¡œ ì´í•´í•˜ê¸°**

```bash
# ìƒí™©: ì›¹ì‡¼í•‘ëª° ì‹œìŠ¤í…œ
# - web-pod (ì›¹í˜ì´ì§€) 
# - api-pod (API ì„œë²„)
# - db-pod (ë°ì´í„°ë² ì´ìŠ¤)

# ì‹œë‚˜ë¦¬ì˜¤ 1: ê³ ê°ì´ ìƒí’ˆ ëª©ë¡ì„ ë³´ê³  ì‹¶ì–´í•¨
1. ì›¹ë¸Œë¼ìš°ì € â†’ web-pod (HTTP ìš”ì²­)
2. web-pod â†’ api-pod (ìƒí’ˆ ëª©ë¡ ìš”ì²­) 
3. api-pod â†’ db-pod (DB ì¿¼ë¦¬)
4. db-pod â†’ api-pod (ê²°ê³¼ ë¦¬í„´)
5. api-pod â†’ web-pod (ê²°ê³¼ ë¦¬í„´)
6. web-pod â†’ ì›¹ë¸Œë¼ìš°ì € (í™”ë©´ í‘œì‹œ)
```

#### ğŸ¯ **ê° Pod ì…ì¥ì—ì„œ ìƒê°í•´ë³´ê¸°**

```yaml
# db-pod ì…ì¥ì—ì„œ:
# "ë‚˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ì•¼. ë‚˜í•œí…Œ ëˆ„ê°€ ì˜¬ ìˆ˜ ìˆì§€?"

apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-policy
spec:
  podSelector:
    matchLabels:
      app: database     # ë‚˜ëŠ” database Podì´ì•¼
  policyTypes:
  - Ingress           # ëˆ„ê°€ ë‚˜í•œí…Œ ì˜¬ ìˆ˜ ìˆëŠ”ì§€ë§Œ ì œì–´
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: api      # api-podë§Œ ë‚˜í•œí…Œ ì˜¬ ìˆ˜ ìˆì–´!
    ports:
    - protocol: TCP
      port: 3306        # MySQL í¬íŠ¸ë¡œë§Œ!
```

> [!tip] ì´í•´ í¬ì¸íŠ¸!
> - database-podëŠ” "ë°›ê¸°ë§Œ" í•˜ëŠ” ì—­í•  â†’ **Ingressë§Œ** ì„¤ì •
> - api-podë§Œ í—ˆìš©í•˜ê³ , web-podëŠ” ì§ì ‘ ì ‘ê·¼ ì°¨ë‹¨
> - ì´ê²Œ ë°”ë¡œ "ê³„ì¸µë³„ ë³´ì•ˆ"!

#### ğŸ“Š NetworkPolicy êµ¬ì¡° ë¶„ì„

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: example-policy
  namespace: production
spec:
  # 1. ì–´ë–¤ Podì— ì ìš©í• ì§€ ì„ íƒ (í•„ìˆ˜)
  podSelector:
    matchLabels:
      app: database
  
  # 2. ì–´ë–¤ ë°©í–¥ì˜ íŠ¸ë˜í”½ì„ ì œì–´í• ì§€ (í•„ìˆ˜)
  policyTypes:
  - Ingress    # ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ ì œì–´
  - Egress     # ë‚˜ê°€ëŠ” íŠ¸ë˜í”½ ì œì–´
  
  # 3. í—ˆìš©í•  Ingress ê·œì¹™ (ì„ íƒ)
  ingress:
  - from:      # ì–´ë””ì„œ ì˜¤ëŠ” íŠ¸ë˜í”½ì„ í—ˆìš©í• ì§€
    - podSelector:
        matchLabels:
          app: api-server
    ports:     # ì–´ë–¤ í¬íŠ¸ë¥¼ í—ˆìš©í• ì§€
    - protocol: TCP
      port: 5432
  
  # 4. í—ˆìš©í•  Egress ê·œì¹™ (ì„ íƒ)  
  egress:
  - to:        # ì–´ë””ë¡œ ê°€ëŠ” íŠ¸ë˜í”½ì„ í—ˆìš©í• ì§€
    - namespaceSelector:
        matchLabels:
          name: monitoring
    ports:
    - protocol: TCP
      port: 80
```

### ğŸ¯ NetworkPolicy ë‹¨ê³„ë³„ ì‹¤ìŠµ

#### ğŸ¯ **ìš°ë¦¬ê°€ ì‹¤ìŠµí•œ ìƒí™© ë‹¤ì‹œë³´ê¸°**

> [!info] ğŸ’¡ ë³µì¡í•œ ì´ë¡ ì€ ê·¸ë§Œ! ìš°ë¦¬ê°€ ë°©ê¸ˆ í…ŒìŠ¤íŠ¸í•œ ê²°ê³¼ë¡œ ì´í•´í•´ë´…ì‹œë‹¤!

**ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼:**
```bash
# âŒ ì´ê±´ ë§‰í˜”ì–´ìš” (5ì´ˆ í›„ íƒ€ì„ì•„ì›ƒ)
kubectl exec netshoot-pod -- curl --connect-timeout 5 http://172.16.0.169

# âœ… ì´ê±´ ì„±ê³µí–ˆì–´ìš” (nginx í˜ì´ì§€ ë‚˜ì˜´)  
kubectl exec netshoot-pod -- curl http://172.16.0.36
```

**ğŸ¤” ì™œ ì´ëŸ° ê²°ê³¼ê°€ ë‚˜ì™”ì„ê¹Œìš”?**

#### ğŸ“Š **Pod ì •ë³´ ë‹¤ì‹œ í™•ì¸**

```bash
kubectl get pods -o wide --show-labels
```

| Pod ì´ë¦„ | IP ì£¼ì†Œ | ë¼ë²¨ | ê²°ê³¼ |
|----------|---------|------|------|
| sensitive-pod | 172.16.0.169 | role=sensitive | âŒ ì ‘ê·¼ ì°¨ë‹¨ |
| internal-pod | 172.16.0.36 | role=internal | âœ… ì ‘ê·¼ ì„±ê³µ |

#### ğŸ” **ë¹„ë°€ì€ ì—¬ê¸°ì— ìˆìŠµë‹ˆë‹¤!**

```yaml
# ìš°ë¦¬ê°€ ì ìš©í•œ NetworkPolicy ë‹¤ì‹œë³´ê¸°
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: networkpolicy-deny-all
spec:
  podSelector:
    matchLabels:
      role: sensitive    # ğŸ¯ í•µì‹¬! ì´ ë¼ë²¨ì„ ê°€ì§„ Podë§Œ!
  policyTypes:
  - Ingress
  - Egress
  # í—ˆìš© ê·œì¹™ì´ ì—†ìŒ = ëª¨ë“  ì ‘ê·¼ ì°¨ë‹¨
```

> [!example] ğŸ  ì§‘ ë¬¸ë‹¨ì† ë¹„ìœ ë¡œ ì´í•´í•˜ê¸°
> 
> **ìš°ë¦¬ ë™ë„¤ì— ì§‘ì´ 4ê°œ ìˆì–´ìš”:**
> - sensitive-pod ì§‘ (172.16.0.169) â†’ ğŸ”’ **ë¬¸ë‹¨ì† ì™„ë£Œ** (NetworkPolicy ì ìš©)
> - internal-pod ì§‘ (172.16.0.36) â†’ ğŸšª **ë¬¸ ì—´ë ¤ìˆìŒ** (ì •ì±… ì ìš© ì•ˆë¨)
> - chk-info-pod ì§‘ (172.16.0.249) â†’ ğŸšª **ë¬¸ ì—´ë ¤ìˆìŒ**
> - netshoot-pod ì§‘ (172.16.0.34) â†’ ğŸšª **ë¬¸ ì—´ë ¤ìˆìŒ**
> 
> **netshoot-podê°€ ë°©ë¬¸í•˜ë ¤ê³  í•  ë•Œ:**
> - sensitive-pod ì§‘: ğŸ”’ "ë¬¸ì´ ì ê²¨ìˆì–´ì„œ ëª»ë“¤ì–´ê°€ìš”!" (ì°¨ë‹¨)
> - internal-pod ì§‘: ğŸšª "ë¬¸ì´ ì—´ë ¤ìˆì–´ì„œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆì–´ìš”!" (í—ˆìš©)

#### ğŸ§  **í•µì‹¬ í¬ì¸íŠ¸ 3ê°€ì§€ë§Œ ê¸°ì–µí•˜ì„¸ìš”!**

1. **podSelector**: "ì–´ë–¤ ì§‘ì— ë¬¸ë‹¨ì†ì„ í• ê¹Œ?" 
   - `role: sensitive` = sensitive-podë§Œ ì„ íƒ
   
2. **policyTypes**: "ì–´ë–¤ ë°©í–¥ì„ ë§‰ì„ê¹Œ?"
   - `Ingress` = ë“¤ì–´ì˜¤ëŠ” ì‚¬ëŒ ë§‰ê¸°
   - `Egress` = ë‚˜ê°€ëŠ” ì‚¬ëŒ ë§‰ê¸°
   
3. **í—ˆìš© ê·œì¹™**: "ëˆ„êµ¬ëŠ” ë“¤ì–´ì˜¬ ìˆ˜ ìˆì„ê¹Œ?"
   - ì—†ìŒ = ì•„ë¬´ë„ ëª»ë“¤ì–´ì˜´ (ì™„ì „ ì°¨ë‹¨)

#### ğŸ¯ **ì´ì œ ì§ì ‘ í•´ë´…ì‹œë‹¤!**

**Q1**: ë§Œì•½ `role: internal` ë¼ë²¨ì„ ê°€ì§„ Podë„ ë§‰ê³  ì‹¶ë‹¤ë©´ ì–´ë–»ê²Œ í•´ì•¼ í• ê¹Œìš”?

<details>
<summary>ì •ë‹µ ë³´ê¸°</summary>

```yaml
# ë°©ë²• 1: ìƒˆë¡œìš´ ì •ì±… ì¶”ê°€
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: block-internal-too
spec:
  podSelector:
    matchLabels:
      role: internal    # internal-podë„ ì°¨ë‹¨!
  policyTypes:
  - Ingress
  - Egress

# ë°©ë²• 2: ê¸°ì¡´ ì •ì±… ìˆ˜ì • (ì—¬ëŸ¬ ë¼ë²¨ ì„ íƒ)
spec:
  podSelector:
    matchExpressions:
    - key: role
      operator: In
      values: ["sensitive", "internal"]
```
</details>

**Q2**: ìš°ë¦¬ í…ŒìŠ¤íŠ¸ì—ì„œ internal-podê°€ ì°¨ë‹¨ ì•ˆëœ ì´ìœ ëŠ”?
> ë‹µ: internal-podëŠ” `role: internal` ë¼ë²¨ì„ ê°€ì§€ê³  ìˆëŠ”ë°, ìš°ë¦¬ ì •ì±…ì€ `role: sensitive`ë§Œ ëŒ€ìƒìœ¼ë¡œ í•˜ê¸° ë•Œë¬¸!

---

#### **STEP 2: PodSelector ê¸°ë°˜ ì„ íƒì  í—ˆìš©**

> [!info] í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹
> "íŠ¹ì • Podì—ì„œ ì˜¤ëŠ” íŠ¸ë˜í”½ë§Œ í—ˆìš©" - ë§ˆì¹˜ ì´ˆëŒ€ì¥ì´ ìˆëŠ” ì‚¬ëŒë§Œ ì…ì¥ í—ˆìš©í•˜ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤.

```yaml
# ğŸ“Š ì„ íƒì  í—ˆìš© ì •ì±…
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-specific-pods
  namespace: default
spec:
  podSelector:
    matchLabels:
      role: internal        # ë³´í˜¸ë°›ì„ Pod
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          app: chk-info     # ì´ ë¼ë²¨ì„ ê°€ì§„ Podì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©
    ports:
    - protocol: TCP
      port: 80             # HTTP í¬íŠ¸ë§Œ í—ˆìš©
  egress:
  - to:
    - podSelector:
        matchLabels:
          app: chk-info     # ì´ ë¼ë²¨ì„ ê°€ì§„ Podë¡œë§Œ ë‚˜ê°ˆ ìˆ˜ ìˆìŒ
    ports:
    - protocol: TCP
      port: 80
```

#### ğŸ“Š **í†µì‹  ê°€ëŠ¥ ì—¬ë¶€ ë§¤íŠ¸ë¦­ìŠ¤**

| ì¶œë°œì§€ Pod      | ëª©ì ì§€ Pod          | ê²°ê³¼   | ì´ìœ                                   |
| ------------ | ---------------- | ---- | ----------------------------------- |
| netshoot-pod | internal-pod     | âŒ ì°¨ë‹¨ | netshoot-podì— `app: chk-info` ë¼ë²¨ ì—†ìŒ |
| chk-info-pod | internal-pod     | âœ… í—ˆìš© | chk-info-podê°€ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ì— í¬í•¨            |
| internal-pod | chk-info-pod     | âœ… í—ˆìš© | egress ê·œì¹™ì— ëª…ì‹œë¨                      |
| internal-pod | external-service | âŒ ì°¨ë‹¨ | egress ê·œì¹™ì— ì—†ìŒ                       |

---

#### **STEP 3: IP Block ê¸°ë°˜ ì œì–´**

> [!example] ì‹¤ì œ ì‹œë‚˜ë¦¬ì˜¤
> "ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬(172.16.0.0/16)ì—ì„œë§Œ ì ‘ê·¼ í—ˆìš©í•˜ê³ , íŠ¹ì • IP ëŒ€ì—­(172.16.6.0/24)ì€ ì œì™¸"

```yaml
# ğŸ“Š IP ê¸°ë°˜ ì ‘ê·¼ ì œì–´
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-internal-network
  namespace: default
spec:
  podSelector: {}           # ëª¨ë“  Podì— ì ìš©
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - ipBlock:
        cidr: 172.16.0.0/16    # ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ í—ˆìš©
        except:
        - 172.16.6.0/24        # íŠ¹ì • ëŒ€ì—­ ì œì™¸
    ports:
    - protocol: TCP
      port: 80
  egress:
  - to:
    - ipBlock:
        cidr: 172.16.0.0/16    # ë‚´ë¶€ë¡œë§Œ ë‚˜ê°€ê¸° í—ˆìš©
    ports:
    - protocol: TCP
      port: 80
  - to: {}                     # DNS í•´ì„ì„ ìœ„í•´ ëª¨ë“  UDP í—ˆìš©
    ports:
    - protocol: UDP
      port: 53
```

#### ğŸ” **IP Block ì •ì±… í•´ì„**

| ì ‘ê·¼ ì‹œë„ | IP ì£¼ì†Œ | ê²°ê³¼ | ì´ìœ  |
|-----------|---------|------|------|
| Pod â†’ Pod | 172.16.0.100 | âœ… í—ˆìš© | ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ë²”ìœ„ |
| Pod â†’ Pod | 172.16.6.50 | âŒ ì°¨ë‹¨ | except ë²”ìœ„ì— í¬í•¨ |
| Pod â†’ ì™¸ë¶€ | 8.8.8.8 | âŒ ì°¨ë‹¨ | ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ ë²”ìœ„ ë°– |
| Pod â†’ DNS | 172.16.0.10:53 | âœ… í—ˆìš© | DNSìš© UDP í—ˆìš© |

---

#### **STEP 4: Namespace ê°„ í†µì‹  ì œì–´**

> [!info] ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬
> "dev2 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ Podë“¤ë§Œ ì„œë¡œ í†µì‹  ê°€ëŠ¥, ë‹¤ë¥¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì™€ëŠ” ê²©ë¦¬"

```yaml
# ğŸ“Š ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬ ì •ì±…
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: isolate-namespace
  namespace: dev2
spec:
  podSelector: {}               # dev2 ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì˜ ëª¨ë“  Pod
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:        # ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë§Œ í—ˆìš©
        matchLabels:
          kubernetes.io/metadata.name: dev2
  egress:
  - to:
    - namespaceSelector:        # ê°™ì€ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œë§Œ í—ˆìš©
        matchLabels:
          kubernetes.io/metadata.name: dev2
  - to: {}                      # ì™¸ë¶€ ì„œë¹„ìŠ¤ í˜¸ì¶œ í—ˆìš©
    ports:
    - protocol: TCP
      port: 443                 # HTTPS
    - protocol: UDP
      port: 53                  # DNS
```

### ğŸ”§ NetworkPolicy ë””ë²„ê¹… ë°©ë²•

#### ğŸ“Š **ë¬¸ì œ í•´ê²° ë‹¨ê³„**

```bash
# 1. NetworkPolicy í™•ì¸
kubectl get networkpolicy -A
kubectl describe networkpolicy deny-all-traffic

# 2. Pod ë¼ë²¨ í™•ì¸
kubectl get pods --show-labels

# 3. ì‹¤ì‹œê°„ ì—°ê²° í…ŒìŠ¤íŠ¸
kubectl exec -it netshoot-pod -- bash
# Pod ë‚´ë¶€ì—ì„œ:
curl -v --connect-timeout 10 http://target-pod-ip
ping target-pod-ip
nslookup target-service

# 4. ë„¤íŠ¸ì›Œí¬ ì •ì±… ì ìš© í™•ì¸
kubectl logs -n kube-system -l app=cilium    # Cilium CNI ì‚¬ìš© ì‹œ
```

#### ğŸš¨ **ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œë“¤**

| ë¬¸ì œ | ì¦ìƒ | í•´ê²° ë°©ë²• |
|------|------|-----------|
| **DNS í•´ì„ ì‹¤íŒ¨** | `nslookup` ì•ˆë¨ | egressì— UDP 53í¬íŠ¸ í—ˆìš© ì¶”ê°€ |
| **ì˜ˆìƒê³¼ ë‹¤ë¥¸ ì°¨ë‹¨** | í—ˆìš©ë˜ì–´ì•¼ í•  í†µì‹  ì°¨ë‹¨ | Pod ë¼ë²¨ê³¼ selector ì¼ì¹˜ í™•ì¸ |
| **ì •ì±… ì ìš© ì•ˆë¨** | ëª¨ë“  í†µì‹ ì´ ê³„ì† í—ˆìš©ë¨ | CNIê°€ NetworkPolicy ì§€ì›í•˜ëŠ”ì§€ í™•ì¸ |
| **ë¶€ë¶„ì  ì°¨ë‹¨** | ì¼ë¶€ ì—°ê²°ë§Œ ì°¨ë‹¨ë¨ | ingress/egress ê·œì¹™ ëª¨ë‘ í™•ì¸ |

### ğŸ¯ ì‹¤ì „ NetworkPolicy ì„¤ê³„ íŒ¨í„´

#### **Pattern 1: ê³„ì¸µë³„ ë³´ì•ˆ (3-Tier Architecture)**

```yaml
# ğŸ“Š ì›¹ ê³„ì¸µ â†’ API ê³„ì¸µë§Œ í—ˆìš©
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: api-layer-policy
spec:
  podSelector:
    matchLabels:
      tier: api
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: web
    ports:
    - protocol: TCP
      port: 8080

---
# ğŸ“Š API ê³„ì¸µ â†’ DB ê³„ì¸µë§Œ í—ˆìš©  
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: database-layer-policy
spec:
  podSelector:
    matchLabels:
      tier: database
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: api
    ports:
    - protocol: TCP
      port: 5432
```

#### **Pattern 2: í™˜ê²½ë³„ ê²©ë¦¬ (ê°œë°œ/ìŠ¤í…Œì´ì§•/í”„ë¡œë•ì…˜)**

```yaml
# ğŸ“Š í”„ë¡œë•ì…˜ í™˜ê²½ ì™„ì „ ê²©ë¦¬
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: production-isolation
  namespace: production
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          env: production
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          env: production
```

---

## ğŸš¨ ì‹¤ë¬´ì—ì„œì˜ NetworkPolicy ê´€ë¦¬ - ë³µì¡ë„ í•´ê²°í•˜ê¸°

> [!warning] í˜„ì‹¤ì  ë¬¸ì œ
> "Podê°€ ìˆ˜ì‹­ê°œ, ìˆ˜ë°±ê°œ ë˜ë©´ ì–´ë–»ê²Œ ê´€ë¦¬í•˜ì§€? ë­˜ ë†“ì¹˜ê³  ìˆëŠ”ì§€ë„ ëª¨ë¥´ê² ì–´..." 
> 
> **ì´ëŸ° ê³ ë¯¼ì´ ì •ë§ í˜„ì‹¤ì ì´ê³  ì¤‘ìš”í•©ë‹ˆë‹¤!** ğŸ¯

### ğŸ” **ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ëŠ” í•´ê²°ì±…ë“¤**

#### **1. ë¼ë²¨ë§ ì „ëµ - ì²´ê³„ì  ë¶„ë¥˜**

> [!example] íšŒì‚¬ì—ì„œ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ë¼ë²¨ ì²´ê³„
> ```yaml
> # ğŸ·ï¸ í‘œì¤€ ë¼ë²¨ë§ ê·œì¹™
> metadata:
>   labels:
>     # ê³„ì¸µ êµ¬ë¶„
>     tier: "web|api|database|cache"
>     # í™˜ê²½ êµ¬ë¶„  
>     env: "dev|staging|prod"
>     # íŒ€ êµ¬ë¶„
>     team: "frontend|backend|devops|ml"
>     # ë³´ì•ˆ ë“±ê¸‰
>     security-level: "public|internal|confidential|restricted"
>     # ì• í”Œë¦¬ì¼€ì´ì…˜
>     app: "user-service|order-service|payment-service"
> ```

#### **2. ë„¤íŠ¸ì›Œí¬ ì •ì±… í…œí”Œë¦¿í™”**

```yaml
# ğŸ“‹ Template 1: ê¸°ë³¸ ê³„ì¸µë³„ ë³´ì•ˆ
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tier-based-policy
  namespace: production
spec:
  podSelector:
    matchLabels:
      tier: database
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: api    # API ê³„ì¸µì—ì„œë§Œ DB ì ‘ê·¼ ê°€ëŠ¥
    ports:
    - protocol: TCP
      port: 3306

---
# ğŸ“‹ Template 2: í™˜ê²½ë³„ ê²©ë¦¬
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy  
metadata:
  name: env-isolation
  namespace: staging
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          env: staging    # ê°™ì€ í™˜ê²½ë¼ë¦¬ë§Œ
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          env: staging
```

#### **3. NetworkPolicy ì‹œê°í™” ë„êµ¬**

```bash
# ğŸ” ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²€ì¦ ë„êµ¬ë“¤

# 1. NetworkPolicy í˜„í™© íŒŒì•…
kubectl get networkpolicy --all-namespaces -o wide

# 2. Pod ë¼ë²¨ í•œëˆˆì— ë³´ê¸°  
kubectl get pods --all-namespaces --show-labels | grep -E "(tier|env|team)"

# 3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸ ìë™í™”
#!/bin/bash
# network-test.sh
PODS=$(kubectl get pods -o name)
for pod in $PODS; do
  echo "Testing connectivity from $pod"
  kubectl exec $pod -- timeout 5 nc -zv target-ip 80 || echo "BLOCKED"
done
```

#### **4. GitOps + IaCë¡œ ê´€ë¦¬**

```yaml
# ğŸ“ ë„¤íŠ¸ì›Œí¬ ì •ì±…ì„ ì½”ë“œë¡œ ê´€ë¦¬
# infrastructure/
# â”œâ”€â”€ network-policies/
# â”‚   â”œâ”€â”€ base/
# â”‚   â”‚   â”œâ”€â”€ deny-all.yaml
# â”‚   â”‚   â”œâ”€â”€ allow-dns.yaml  
# â”‚   â”‚   â””â”€â”€ allow-monitoring.yaml
# â”‚   â”œâ”€â”€ environments/
# â”‚   â”‚   â”œâ”€â”€ dev/
# â”‚   â”‚   â”œâ”€â”€ staging/
# â”‚   â”‚   â””â”€â”€ prod/
# â”‚   â””â”€â”€ applications/
# â”‚       â”œâ”€â”€ web-tier.yaml
# â”‚       â”œâ”€â”€ api-tier.yaml
# â”‚       â””â”€â”€ db-tier.yaml
```

### ğŸ¯ **ë‹¨ê³„ë³„ ë„ì… ì „ëµ (í˜„ì‹¤ì  ì ‘ê·¼)**

#### **Phase 1: ê¸°ë³¸ ë³´ì•ˆ ì ìš©**

```bash
# 1. ì¼ë‹¨ ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ê¸°ë³¸ ê·œì¹™ë§Œ ì ìš©
kubectl apply -f base-security-policies.yaml
```

```yaml
# base-security-policies.yaml
# ğŸš¨ ìµœì†Œí•œì˜ ë³´ì•ˆ - DNSë§Œ í—ˆìš©
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-only
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to: []
    ports:
    - protocol: UDP
      port: 53    # DNSë§Œ í—ˆìš©
```

#### **Phase 2: ì ì§„ì  ì„¸ë¶„í™”**

```yaml
# ë†’ì€ ìœ„í—˜ë„ë¶€í„° ì„¸ë¶„í™”
# 1. ë°ì´í„°ë² ì´ìŠ¤ ë¨¼ì €
# 2. ê²°ì œ ì‹œìŠ¤í…œ 
# 3. ì‚¬ìš©ì ì¸ì¦
# 4. ì¼ë°˜ API
```

#### **Phase 3: ëª¨ë‹ˆí„°ë§ & ê²€ì¦**

```bash
# ğŸ” ì •ê¸°ì  ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸
#!/bin/bash
echo "=== NetworkPolicy ê²€ì¦ ë ˆí¬íŠ¸ ==="
echo "1. ë³´í˜¸ë˜ì§€ ì•Šì€ ë°ì´í„°ë² ì´ìŠ¤ Pod:"
kubectl get pods -l tier=database --all-namespaces -o custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name | while read ns name; do
  if ! kubectl get networkpolicy -n $ns | grep -q $name; then
    echo "âš ï¸  $ns/$name - ì •ì±… ì—†ìŒ!"
  fi
done

echo "2. ì™¸ë¶€ ì ‘ê·¼ ê°€ëŠ¥í•œ Pod:"
# ì™¸ë¶€ IPë¡œ ì ‘ê·¼ ê°€ëŠ¥í•œ Pod ê²€ì‚¬ ë¡œì§
```

### ğŸ› ï¸ **ì‹¤ë¬´ íŒ & íŠ¸ë¦­**

#### **1. ë””ë²„ê¹…ìš© ì„ì‹œ ì •ì±…**

```yaml
# ğŸš§ ë¬¸ì œ í•´ê²°ìš© - ëª¨ë“  ê²ƒ í—ˆìš© (ì„ì‹œ)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: debug-allow-all
  annotations:
    purpose: "debugging-only"
    expires: "2025-12-01"
spec:
  podSelector:
    matchLabels:
      debug: "true"
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - {}
  egress:
  - {}
```

#### **2. ì ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸**

```markdown
# ğŸ“‹ NetworkPolicy ë°°í¬ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] DNS í•´ì„ì´ ê°€ëŠ¥í•œê°€? (UDP 53 í—ˆìš©)
- [ ] ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ ì ‘ê·¼ ê°€ëŠ¥í•œê°€?
- [ ] Health check ì—”ë“œí¬ì¸íŠ¸ ì ‘ê·¼ ê°€ëŠ¥í•œê°€?
- [ ] ë¡œê·¸ ìˆ˜ì§‘ ì‹œìŠ¤í…œ ì ‘ê·¼ ê°€ëŠ¥í•œê°€?
- [ ] í•„ìˆ˜ ì™¸ë¶€ API í˜¸ì¶œ ê°€ëŠ¥í•œê°€?

# ğŸ§ª í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
kubectl exec test-pod -- nslookup google.com     # DNS ì²´í¬
kubectl exec test-pod -- curl health-check-url   # Health ì²´í¬  
kubectl exec test-pod -- wget monitoring-url     # ëª¨ë‹ˆí„°ë§ ì²´í¬
```

#### **3. ì‘ê¸‰ ìƒí™© ëŒ€ì‘**

```bash
# ğŸš¨ ë„¤íŠ¸ì›Œí¬ ì •ì±…ìœ¼ë¡œ ì¸í•œ ì¥ì•  ì‹œ ì‘ê¸‰ ëŒ€ì‘

# 1. íŠ¹ì • ì •ì±… ì¦‰ì‹œ ë¹„í™œì„±í™”
kubectl patch networkpolicy problematic-policy -p '{"spec":{"podSelector":{"matchLabels":{"disabled":"true"}}}}'

# 2. ì „ì²´ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì •ì±… ì„ì‹œ í•´ì œ
kubectl get networkpolicy -n problem-namespace -o name | xargs kubectl delete

# 3. ê¸´ê¸‰ í—ˆìš© ì •ì±… ì ìš©
kubectl apply -f emergency-allow-all.yaml
```

### ğŸ¯ **ì‹¤ë¬´ ê¶Œì¥ ì‚¬í•­**

> [!tip] í° ì¡°ì§ì—ì„œ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ë°©ë²•
> 
> **1. ì¡°ì§ë³„ ì±…ì„ ë¶„ë‹´**
> - **í”Œë«í¼íŒ€**: ê¸°ë³¸ ì •ì±… í…œí”Œë¦¿ ì œê³µ
> - **ë³´ì•ˆíŒ€**: ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ ì •ì˜
> - **ê°œë°œíŒ€**: ì• í”Œë¦¬ì¼€ì´ì…˜ë³„ ì„¸ë¶€ ì •ì±…
> 
> **2. ë„êµ¬ í™œìš©**
> - **Helm**: ì •ì±… í…œí”Œë¦¿ ë°°í¬
> - **ArgoCD**: GitOpsë¡œ ì •ì±… ê´€ë¦¬  
> - **OPA Gatekeeper**: ì •ì±… ì¤€ìˆ˜ ê°•ì œ
> - **Cilium**: ê³ ê¸‰ ë„¤íŠ¸ì›Œí¬ ì •ì±…
> 
> **3. ë‹¨ê³„ì  ì ìš©**
> - ë¨¼ì € ê´€ì°° ëª¨ë“œë¡œ ì‹œì‘
> - ì ì§„ì ìœ¼ë¡œ ì—„ê²©í•˜ê²Œ ë³€ê²½
> - ì¶©ë¶„í•œ ëª¨ë‹ˆí„°ë§ê³¼ ì•Œë¦¼ ì„¤ì •

---

**ê²°ë¡ : NetworkPolicyëŠ” í˜¼ì ê´€ë¦¬í•˜ëŠ”ê²Œ ì•„ë‹ˆë¼, ë„êµ¬ì™€ í”„ë¡œì„¸ìŠ¤ë¡œ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒ!** ğŸ¯

ë³µì¡í•˜ë‹¤ê³  í¬ê¸°í•˜ì§€ ë§ˆì‹œê³ , **ì‘ì€ ê²ƒë¶€í„° ì²´ê³„ì ìœ¼ë¡œ ì‹œì‘**í•˜ëŠ”ê²Œ í•µì‹¬ì…ë‹ˆë‹¤! ğŸ˜Š

---

## ğŸ¯ ì‹¤ì „ ì˜ˆì‹œ

### ğŸ’¡ ë©€í‹°í…Œë„ŒíŠ¸ í™˜ê²½ ë³´ì•ˆ ì„¤ì •

#### ğŸ¤” ì§ˆë¬¸: "ê°œë°œíŒ€ë³„ë¡œ ë¦¬ì†ŒìŠ¤ë¥¼ ë¶„ë¦¬í•˜ê³  ë³´ì•ˆì„ ì ìš©í•˜ë ¤ë©´?"

#### ğŸ“‹ êµ¬ì²´ì ì¸ ì‹œë‚˜ë¦¬ì˜¤

> [!example] ì‹¤ì œ ìƒí™©
> 1. **ë¬¸ì œ**: dev1íŒ€ê³¼ dev2íŒ€ì´ ê°™ì€ í´ëŸ¬ìŠ¤í„°ë¥¼ ì‚¬ìš©í•˜ëŠ”ë° ì„œë¡œì˜ ë¦¬ì†ŒìŠ¤ì— ì ‘ê·¼ ê°€ëŠ¥
> 2. **ìš”êµ¬ì‚¬í•­**: íŒ€ë³„ ê²©ë¦¬, ë¦¬ì†ŒìŠ¤ í• ë‹¹ëŸ‰ ì œí•œ, ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬
> 3. **í•´ê²°ë°©ë²•**: RBAC + ResourceQuota + NetworkPolicy ì¡°í•©
> 4. **ê²°ê³¼**: ì•ˆì „í•˜ê³  ê³µì •í•œ ë©€í‹°í…Œë„ŒíŠ¸ í™˜ê²½ êµ¬ì¶•

#### ğŸ’» í†µí•© ë³´ì•ˆ ì„¤ì •

```bash
# 1. RBAC ì„¤ì •
kubectl apply -f ns-sa-dev-both.yaml
kubectl apply -f dev1/role-get-dev1.yaml
kubectl apply -f dev1/rolebinding-dev1.yaml

# 2. ë¦¬ì†ŒìŠ¤ í• ë‹¹ëŸ‰ ì„¤ì •
kubectl apply -f ResourceQuota.yaml

# 3. ë¦¬ì†ŒìŠ¤ ì œí•œ ì •ì±… ì„¤ì •
kubectl apply -f LimitRange.yaml

# 4. ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ ì •ì±… ì„¤ì •
kubectl apply -f 1-2-NetworkPolicy-deny-all.yaml

# ê²€ì¦
kubectl get resourcequota,limitrange,networkpolicy -n dev1
```

#### ğŸ“Š ë³´ì•ˆ ì •ì±… íš¨ê³¼ ì¸¡ì •

| ë³´ì•ˆ ì˜ì—­ | ì ìš© ì „ | ì ìš© í›„ | ê°œì„  íš¨ê³¼ |
|-----------|---------|---------|-----------|
| **ê¶Œí•œ ê´€ë¦¬** | ëª¨ë“  ì‚¬ìš©ìê°€ ì „ì²´ ì ‘ê·¼ | ì—­í• ë³„ ìµœì†Œ ê¶Œí•œ | ğŸ”’ ê¶Œí•œ ê²©ë¦¬ |
| **ë¦¬ì†ŒìŠ¤ ì‚¬ìš©** | ë¬´ì œí•œ ì‚¬ìš© ê°€ëŠ¥ | íŒ€ë³„ í• ë‹¹ëŸ‰ ì œí•œ | âš–ï¸ ê³µì •í•œ ë¶„ë°° |
| **ë„¤íŠ¸ì›Œí¬** | ëª¨ë“  í†µì‹  í—ˆìš© | ì •ì±… ê¸°ë°˜ ì°¨ë‹¨ | ğŸ›¡ï¸ ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬ |

