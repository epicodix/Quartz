# 6.7 ν…μΈνΈ(Taints)μ™€ ν†¨λ¬λ μ΄μ…(Tolerations)μ νλ“ ν• λ‹Ή μ΅°κ±΄

## π― ν•™μµ λ©ν‘
- ν…μΈνΈμ™€ ν†¨λ¬λ μ΄μ…μ λ™μ‘ μ›λ¦¬ μ΄ν•΄
- Equal/Exists μ—°μ‚°μλ³„ λ§¤μΉ­ κ·μΉ™ μµλ“
- μ‹¤μ  YAML μ½”λ“ μ‘μ„± λ° μ μ© λ°©λ²• ν•™μµ

## π“‹ κΈ°λ³Έ κ°λ…

### ν…μΈνΈ(Taints)
- λ…Έλ“μ— μ„¤μ •λμ–΄ νΉμ • νλ“μ μ¤μΌ€μ¤„λ§μ„ μ ν•ν•λ” λ©”μ»¤λ‹μ¦
- **Key**, **Value**, **Effect** 3κ°€μ§€ μ”μ†λ΅ κµ¬μ„±

### ν†¨λ¬λ μ΄μ…(Tolerations) 
- νλ“μ— μ„¤μ •λμ–΄ ν…μΈνΈκ°€ μλ” λ…Έλ“μ— μ¤μΌ€μ¤„λ§λ  μ μλ„λ΅ ν—μ©ν•λ” λ©”μ»¤λ‹μ¦
- ν…μΈνΈμ™€ λ§¤μΉ­λλ” **Key**, **Value**, **Effect**μ™€ **Operator** μ„¤μ •

## π› οΈ μ‹¤μµ ν™κ²½ μ„¤μ •

### λ…Έλ“μ— ν…μΈνΈ μ„¤μ •
```bash
# λ…Έλ“μ— ν…μΈνΈ μ¶”κ°€
kubectl taint nodes <node-name> key=value:NoSchedule

# μμ‹: worker λ…Έλ“μ— νΉμ μ©λ„ ν…μΈνΈ μ„¤μ •
kubectl taint nodes worker1 special=true:NoSchedule
kubectl taint nodes worker2 gpu=nvidia:NoSchedule

# ν…μΈνΈ ν™•μΈ
kubectl describe node <node-name> | grep Taints

# ν…μΈνΈ μ κ±°
kubectl taint nodes <node-name> key=value:NoSchedule-
```

### λ§μ¤ν„° λ…Έλ“ ν…μΈνΈ ν™•μΈ
```bash
# λ§μ¤ν„° λ…Έλ“μ κΈ°λ³Έ ν…μΈνΈ ν™•μΈ
kubectl describe node master | grep Taints
# μΌλ°μ μΌλ΅: node-role.kubernetes.io/master:NoSchedule
```

## π” λ§¤μΉ­ κ·μΉ™

### Operator: Equal (κ°’ λΉ„κµ)

#### β… νλ“ ν• λ‹Ή μ„±κ³µ μ΅°κ±΄
1. **λ¨λ“  μ”μ† μ™„μ „ μΌμΉ**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `K=a, V=1, E=NoSchedule`
   - κ²°κ³Ό: K(O), V(O), E(O) β†’ β… λ°°ν¬ κ°€λ¥

2. **Value μƒλµ (μ™€μΌλ“μΉ΄λ“)**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `K=a, V=-, E=NoSchedule`
   - κ²°κ³Ό: K(O), V(-), E(O) β†’ β… λ°°ν¬ κ°€λ¥

#### β νλ“ ν• λ‹Ή κ±°λ¶€ μ΅°κ±΄
1. **Key λ¶μΌμΉ**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `K=b, V=1, E=NoSchedule`
   - κ²°κ³Ό: K(X), V(X), E(X) β†’ β λ°°ν¬ λ¶κ°€

2. **Valueλ§ λ¶μΌμΉ**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `K=a, V=2, E=NoSchedule`
   - κ²°κ³Ό: K(O), V(X), E(X) β†’ β λ°°ν¬ λ¶κ°€

3. **Effectλ§ λ¶μΌμΉ**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `K=a, V=1, E=PreferNoSchedule`
   - κ²°κ³Ό: K(O), V(O), E(X) β†’ β λ°°ν¬ λ¶κ°€

### Operator: Exists (μ΅΄μ¬ μ—¬λ¶€λ§ ν™•μΈ)

#### β… νλ“ ν• λ‹Ή μ„±κ³µ μ΅°κ±΄
1. **Keyμ™€ Effect μΌμΉ, Value λ¬΄μ‹**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `K=a, E=NoSchedule (Operator: Exists)`
   - κ²°κ³Ό: K(O), E(O) β†’ β… λ°°ν¬ κ°€λ¥

2. **Keyλ§ μΌμΉ, Effect μƒλµ**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `K=a (Operator: Exists)`
   - κ²°κ³Ό: K(O) β†’ β… λ°°ν¬ κ°€λ¥ (λ¨λ“  Effect ν—μ©)

3. **μ™„μ „ μ™€μΌλ“μΉ΄λ“**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `(λΉ ν†¨λ¬λ μ΄μ…, Operator: Exists)`
   - κ²°κ³Ό: β… λ¨λ“  ν…μΈνΈ λ¬΄μ‹ν•κ³  λ°°ν¬ κ°€λ¥

## π”§ YAML μ½”λ“ μμ 

### 1. Equal μ—°μ‚°μ μμ 

#### κΈ°λ³Έ ν†¨λ¬λ μ΄μ… (μ™„μ „ μΌμΉ)
```yaml
# pod-with-toleration-equal.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-equal-match
spec:
  tolerations:
  - key: "special"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"
  containers:
  - name: nginx
    image: nginx:1.20
```

#### Value μƒλµ ν†¨λ¬λ μ΄μ…
```yaml
# pod-with-toleration-equal-wildcard.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-equal-wildcard
spec:
  tolerations:
  - key: "special"
    operator: "Equal"
    # value μƒλµ - λ¨λ“  κ°’μ— λ€ν•΄ ν—μ©
    effect: "NoSchedule"
  containers:
  - name: nginx
    image: nginx:1.20
```

### 2. Exists μ—°μ‚°μ μμ 

#### Keyμ™€ Effect λ§¤μΉ­
```yaml
# pod-with-toleration-exists.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-exists-match
spec:
  tolerations:
  - key: "gpu"
    operator: "Exists"
    effect: "NoSchedule"
  containers:
  - name: cuda-app
    image: nvidia/cuda:11.0-base
```

#### Keyλ§ λ§¤μΉ­ (Effect μƒλµ)
```yaml
# pod-with-toleration-exists-key-only.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-exists-key-only
spec:
  tolerations:
  - key: "special"
    operator: "Exists"
    # effect μƒλµ - λ¨λ“  effectμ— λ€ν•΄ ν—μ©
  containers:
  - name: nginx
    image: nginx:1.20
```

#### μ™„μ „ μ™€μΌλ“μΉ΄λ“ (λ¨λ“  ν…μΈνΈ ν—μ©)
```yaml
# pod-with-toleration-wildcard.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-wildcard-toleration
spec:
  tolerations:
  - operator: "Exists"
    # key, value, effect λ¨λ‘ μƒλµ - λ¨λ“  ν…μΈνΈ ν—μ©
  containers:
  - name: nginx
    image: nginx:1.20
```

### 3. λ‹¤μ¤‘ ν†¨λ¬λ μ΄μ… μμ 
```yaml
# pod-with-multiple-tolerations.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-multiple-tolerations
spec:
  tolerations:
  - key: "special"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"
  - key: "gpu"
    operator: "Exists"
    effect: "NoSchedule"
  - key: "dedicated"
    operator: "Equal"
    value: "database"
    effect: "NoExecute"
    tolerationSeconds: 3600  # 1μ‹κ°„ ν›„ eviction
  containers:
  - name: multi-toleration-app
    image: nginx:1.20
```

### 4. tolerationSeconds ν™μ© μμ 
```yaml
# pod-with-toleration-seconds.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-with-time-limit
spec:
  tolerations:
  - key: "maintenance"
    operator: "Equal"
    value: "true"
    effect: "NoExecute"
    tolerationSeconds: 300  # 5λ¶„ ν›„ eviction
  containers:
  - name: temporary-app
    image: nginx:1.20
```

## π§ μ‹¤μµ μ‹λ‚λ¦¬μ¤

### μ‹λ‚λ¦¬μ¤ 1: νΉμ λ©μ  λ…Έλ“ κµ¬μ„±
```bash
# 1. GPU μ „μ© λ…Έλ“ ν…μΈνΈ μ„¤μ •
kubectl taint nodes worker-gpu gpu=nvidia:NoSchedule

# 2. GPU μ›ν¬λ΅λ“ νλ“ λ°°ν¬
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: gpu-workload
spec:
  tolerations:
  - key: "gpu"
    operator: "Equal"
    value: "nvidia"
    effect: "NoSchedule"
  containers:
  - name: cuda-app
    image: nvidia/cuda:11.0-base
    command: ["sleep", "3600"]
  nodeSelector:
    gpu: "nvidia"
EOF

# 3. κ²°κ³Ό ν™•μΈ
kubectl get pods -o wide
kubectl describe pod gpu-workload
```

### μ‹λ‚λ¦¬μ¤ 2: λ°μ΄ν„°λ² μ΄μ¤ μ „μ© λ…Έλ“
```bash
# 1. λ°μ΄ν„°λ² μ΄μ¤ μ „μ© λ…Έλ“ μ„¤μ •
kubectl taint nodes worker-db dedicated=database:NoSchedule
kubectl taint nodes worker-db dedicated=database:NoExecute

# 2. λ°μ΄ν„°λ² μ΄μ¤ νλ“ λ°°ν¬
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: database-pod
spec:
  tolerations:
  - key: "dedicated"
    operator: "Equal"
    value: "database"
    effect: "NoSchedule"
  - key: "dedicated"
    operator: "Equal"
    value: "database"
    effect: "NoExecute"
  containers:
  - name: mysql
    image: mysql:8.0
    env:
    - name: MYSQL_ROOT_PASSWORD
      value: "password"
  nodeSelector:
    dedicated: "database"
EOF
```

### μ‹λ‚λ¦¬μ¤ 3: λ§μ¤ν„° λ…Έλ“μ— νλ“ λ°°ν¬
```bash
# 1. λ§μ¤ν„° λ…Έλ“ ν…μΈνΈ ν™•μΈ
kubectl describe node master | grep Taints

# 2. λ§μ¤ν„° λ…Έλ“μ— λ°°ν¬ κ°€λ¥ν• νλ“ μƒμ„±
kubectl apply -f - <<EOF
apiVersion: v1
kind: Pod
metadata:
  name: master-pod
spec:
  tolerations:
  - key: "node-role.kubernetes.io/master"
    operator: "Exists"
    effect: "NoSchedule"
  containers:
  - name: nginx
    image: nginx:1.20
  nodeSelector:
    kubernetes.io/hostname: "master"
EOF
```

## π”¬ νΈλ¬λΈ”μν… κ°€μ΄λ“

### μΌλ°μ μΈ λ¬Έμ μ™€ ν•΄κ²°λ°©λ²•

#### 1. νλ“κ°€ Pending μƒνƒλ΅ λ‚¨μ•„μλ” κ²½μ°
```bash
# λ¬Έμ  μ§„λ‹¨
kubectl describe pod <pod-name>
kubectl get events --sort-by='.lastTimestamp'

# λ…Έλ“ ν…μΈνΈ ν™•μΈ
kubectl describe nodes | grep -A5 Taints

# ν•΄κ²°λ°©λ²•: μ μ ν• ν†¨λ¬λ μ΄μ… μ¶”κ°€ λλ” ν…μΈνΈ μ κ±°
```

#### 2. λ§μ¤ν„° λ…Έλ“μ— νλ“κ°€ μ¤μΌ€μ¤„λμ§€ μ•λ” κ²½μ°
```bash
# λ§μ¤ν„° λ…Έλ“ ν…μΈνΈ ν™•μΈ
kubectl describe node master | grep Taints

# ν•΄κ²°λ°©λ²•: λ§μ¤ν„° λ…Έλ“μ© ν†¨λ¬λ μ΄μ… μ¶”κ°€
tolerations:
- key: "node-role.kubernetes.io/master"
  operator: "Exists"
  effect: "NoSchedule"
```

#### 3. NoExecute ν…μΈνΈλ΅ μΈν• μμƒμΉ λ»ν• νλ“ μΆ…λ£
```bash
# μ΄λ²¤νΈ λ΅κ·Έ ν™•μΈ
kubectl get events --field-selector involvedObject.name=<pod-name>

# ν•΄κ²°λ°©λ²•: tolerationSeconds μ΅°μ • λλ” μ μ ν• ν†¨λ¬λ μ΄μ… μ¶”κ°€
tolerations:
- key: "maintenance"
  operator: "Equal"
  value: "true" 
  effect: "NoExecute"
  tolerationSeconds: 7200  # 2μ‹κ°„μΌλ΅ μ—°μ¥
```

### ν…μ¤νΈ λ° κ²€μ¦ λ…λ Ήμ–΄
```bash
# 1. λ¨λ“  λ…Έλ“μ ν…μΈνΈ μƒνƒ ν™•μΈ
kubectl get nodes -o custom-columns=NAME:.metadata.name,TAINTS:.spec.taints --no-headers

# 2. νΉμ • ν…μΈνΈκ°€ μλ” λ…Έλ“ μ°ΎκΈ°
kubectl get nodes -o json | jq '.items[] | select(.spec.taints[]?.key=="gpu") | .metadata.name'

# 3. νλ“μ ν†¨λ¬λ μ΄μ… ν™•μΈ
kubectl get pod <pod-name> -o jsonpath='{.spec.tolerations}'

# 4. λ…Έλ“λ³„ νλ“ λ°°μΉ ν„ν™© ν™•μΈ
kubectl get pods -o wide --all-namespaces | grep <node-name>
```

## π“ μ‹¬ν™” ν•™μµ λ‚΄μ©

### 1. μ‹μ¤ν… κΈ°λ³Έ ν†¨λ¬λ μ΄μ…
μΏ λ²„λ„¤ν‹°μ¤λ” νΉμ • μƒν™©μ—μ„ μλ™μΌλ΅ ν†¨λ¬λ μ΄μ…μ„ μ¶”κ°€ν•©λ‹λ‹¤:

```yaml
# DaemonSetμ€ κΈ°λ³Έμ μΌλ΅ λ‹¤μ ν†¨λ¬λ μ΄μ…μ„ κ°€μ§‘λ‹λ‹¤
tolerations:
- effect: NoSchedule
  operator: Exists
- key: CriticalAddonsOnly
  operator: Exists
- effect: NoExecute
  operator: Exists
```

### 2. PodDisruptionBudgetκ³Όμ μ—°κ΄€μ„±
```yaml
# NoExecuteμ™€ PDB ν•¨κ» μ‚¬μ© μμ 
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: db-pdb
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: database
```

### 3. ν΄λ¬μ¤ν„° μ¤ν† μ¤μΌ€μΌλ¬μ™€ ν…μΈνΈ
```bash
# μ¤ν† μ¤μΌ€μΌλ¬κ°€ ν…μΈνΈλ λ…Έλ“λ¥Ό κ³ λ ¤ν•λ„λ΅ μ„¤μ •
cluster-autoscaler.kubernetes.io/safe-to-evict: "true"
```

## β οΈ μ£Όμμ‚¬ν•­ λ° λ² μ¤νΈ ν”„λ™ν‹°μ¤

### μ£Όμμ‚¬ν•­
1. **NoExecute μ‚¬μ© μ‹ μ£Όμ**: κΈ°μ΅΄ νλ“λ¥Ό μ¦‰μ‹ μΆ…λ£μ‹ν‚¬ μ μμ
2. **tolerationSeconds μ μ ν μ„¤μ •**: λ„λ¬΄ μ§§μΌλ©΄ μ„λΉ„μ¤ μ¤‘λ‹¨, λ„λ¬΄ κΈΈλ©΄ λ¦¬μ†μ¤ λ‚­λΉ„
3. **μ™€μΌλ“μΉ΄λ“ ν†¨λ¬λ μ΄μ… λ‚¨μ© κΈμ§€**: λ³΄μ•μƒ μ„ν—ν•  μ μμ

### λ² μ¤νΈ ν”„λ™ν‹°μ¤
1. **λ©μ λ³„ λ„¤μ΄λ° μ»¨λ²¤μ… μ‚¬μ©**:
   ```bash
   # μΆ‹μ€ μ
   kubectl taint nodes gpu-node1 hardware=gpu:NoSchedule
   kubectl taint nodes db-node1 workload=database:NoSchedule
   
   # λ‚μ μ  
   kubectl taint nodes worker1 a=b:NoSchedule
   ```

2. **λ¬Έμ„ν™” λ° λΌλ²¨λ§**:
   ```bash
   kubectl label nodes gpu-node1 description="GPU-enabled node for ML workloads"
   ```

3. **λ‹¨κ³„μ  μ μ©**:
   ```bash
   # 1λ‹¨κ³„: PreferNoScheduleλ΅ μ‹μ‘
   kubectl taint nodes worker1 special=true:PreferNoSchedule
   
   # 2λ‹¨κ³„: κ²€μ¦ ν›„ NoScheduleλ΅ λ³€κ²½
   kubectl taint nodes worker1 special=true:PreferNoSchedule-
   kubectl taint nodes worker1 special=true:NoSchedule
   ```

#### β νλ“ ν• λ‹Ή κ±°λ¶€ μ΅°κ±΄
1. **Key λ¶μΌμΉ**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `K=b, E=NoSchedule (Operator: Exists)`
   - κ²°κ³Ό: K(X) β†’ β λ°°ν¬ λ¶κ°€

2. **Effect λ¶μΌμΉ**
   - ν…μΈνΈ: `K=a, V=1, E=NoSchedule`
   - ν†¨λ¬λ μ΄μ…: `K=a, E=PreferNoSchedule (Operator: Exists)`
   - κ²°κ³Ό: K(O), E(X) β†’ β λ°°ν¬ λ¶κ°€

## π― Effect μ ν•

| Effect | μ„¤λ… |
|--------|------|
| **NoSchedule** | κ°€μ¥ κΈ°λ³Έμ μΈ μ„¤μ •. λ…Έλ“μ— ν…μΈνΈκ°€ μ„¤μ •λμ–΄ μμ§€ μ•μ€ κ²½μ° νλ“κ°€ λ…Έλ“μ— μ¤μΌ€μ¤„λμ§€ μ•μ. ν†¨λ¬λ μ΄μ…μ„ ν†µν• λ°°ν¬λ§ κ°€λ¥ |
| **PreferNoSchedule** | NoScheduleκ³Ό μ μ‚¬ν•μ§€λ§ μ¤μΌ€μ¤„λ¬μ—μ„ λ” μ΄μƒ ν• λ‹Ήν•  μ μλ” λ…Έλ“κ°€ μ—†λ” κ²½μ° ν…μΈνΈ μ„¤μ •μ„ λ¬΄μ‹ν•κ³  μ¤μΌ€μ¤„ν•¨ |
| **NoExecute** | NoScheduleμ— ν„μ¬ ν• λ‹Ήλ νλ“μ—λ„ λ°”λ΅ μ μ©λλ„λ΅ μ¤μΌ€μ¤„μ„ λ‹¤μ‹ μ΅°μ •ν•λ” κΈ°λ¥ μ¶”κ°€. ν†¨λ¬λ μ΄μ…μ΄ μ—†λ” νλ“λ” λ¨λ‘ λ…Έλ“μ—μ„ μ κ±°ν•¨ |

## π’΅ ν•µμ‹¬ μ •λ¦¬

### Equal μ—°μ‚°μ
- **μ—„κ²©ν• λ§¤μΉ­**: Key, Value, Effectκ°€ μ •ν™•ν μΌμΉν•΄μ•Ό ν•¨
- **Value μƒλµ κ°€λ¥**: `-`λ΅ ν‘μ‹ν•λ©΄ Value λ¬΄μ‹
- **ν•λ‚λΌλ„ λ¶μΌμΉν•λ©΄ λ°°ν¬ λ¶κ°€**

### Exists μ—°μ‚°μ
- **λμ¨ν• λ§¤μΉ­**: Keyμ μ΅΄μ¬λ§ ν™•μΈ, Valueλ” μλ™ λ¬΄μ‹
- **Effectλ” μ—¬μ „ν μ¤‘μ”**: Effectκ°€ μΌμΉν•΄μ•Ό ν•¨
- **μ™„μ „ μ™€μΌλ“μΉ΄λ“ κ°€λ¥**: λ¨λ“  ν•­λ© μƒλµ μ‹ λ¨λ“  ν…μΈνΈ ν—μ©

## π“– λ²”λ΅€

| κΈ°νΈ | μλ―Έ |
|------|------|
| **O** | κ°’μ„ μ…λ ¥ν•λ©° μΌμΉ |
| **X** | κ°’μ„ μ…λ ¥ν•λ©° λ¶μΌμΉ |
| **-** | κ°’μ„ μ…λ ¥ν•μ§€ μ•κ³  μƒλµ |
| **K** | Key |
| **V** | Value |
| **E** | Effect |

---

**μ¶μ²**: μ»¨ν…μ΄λ„ μΈν”„λΌ ν™κ²½ κµ¬μ¶•μ„ μ„ν• μΏ λ²„λ„¤ν‹°μ¤/λ„μ»¤  
**μ μ‘**: μ΅°ν›μ‹¬, κ·Όμ°λ¬Έ, μ„±μ£Ό  
**κ΄€λ ¨ κ°•μ**: 
1. μ‰½κ² μ‹μ‘ν•λ” μΏ λ²„λ„¤ν‹°μ¤
2. κ·Έλ¦ΌμΌλ΅ λ°°μ°λ” μΏ λ²„λ„¤ν‹°μ¤  
3. μ‹¤μµμΌλ΅ λ°°μ°λ” ν”„λ΅λ©”ν…μ°μ¤