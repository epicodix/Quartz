
# Part 1: ìŠ¤ì¼€ì¤„ë§ 

---

## ğŸ”§ kube-scheduler ìƒì„¸ ë™ì‘ ì›ë¦¬

### ìŠ¤ì¼€ì¤„ë§ í (Scheduling Queue)

```
[Pod ìƒì„±] â†’ [API Server] â†’ [Schedulerì˜ 3ê°€ì§€ í]
                                   â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                        â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ Active â”‚ -----> â”‚ Backoff    â”‚ -----> â”‚ Unschedulableâ”‚   â”‚
â”‚ Queue  â”‚        â”‚ Queue      â”‚        â”‚ Queue        â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
    â†“                   â†“                       â†“           â”‚
ìŠ¤ì¼€ì¤„ë§ ì‹œë„      ì¬ì‹œë„ ëŒ€ê¸° ì¤‘         ìŠ¤ì¼€ì¤„ ë¶ˆê°€     â”‚
(ì¦‰ì‹œ ì²˜ë¦¬)       (ì§€ìˆ˜ ë°±ì˜¤í”„)          (ì´ë²¤íŠ¸ ëŒ€ê¸°)    â”‚
                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ìƒì„¸ í”Œë¡œìš°

yaml

```
# Pod ìƒì„±
apiVersion: v1
kind: Pod
metadata:
  name: example-pod
spec:
  containers:
  - name: app
    image: nginx
  # nodeNameì´ ì—†ìŒ!
```
```
[1] Pod ìƒì„± â†’ API Server â†’ etcd ì €ì¥
    â†“
[2] Scheduler Watch â†’ "nodeName ì—†ëŠ” Pod ë°œê²¬"
    â†“
[3] Active Queueì— ì¶”ê°€
    â†“
[4] ìŠ¤ì¼€ì¤„ë§ ì‚¬ì´í´ ì‹œì‘
    â†“
    â”œâ”€ PreFilter í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ (ì‚¬ì „ ê²€ì¦)
    â”œâ”€ Filter í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ (ë…¸ë“œë³„ ê²€ì‚¬)
    â”œâ”€ PostFilter í”ŒëŸ¬ê·¸ì¸ (ëª¨ë“  ë…¸ë“œ ì‹¤íŒ¨ ì‹œ)
    â”œâ”€ PreScore í”ŒëŸ¬ê·¸ì¸ (ì ìˆ˜ ê³„ì‚° ì¤€ë¹„)
    â”œâ”€ Score í”ŒëŸ¬ê·¸ì¸ (ë…¸ë“œë³„ ì ìˆ˜)
    â”œâ”€ NormalizeScore (ì ìˆ˜ ì •ê·œí™”)
    â””â”€ Reserve í”ŒëŸ¬ê·¸ì¸ (ë¦¬ì†ŒìŠ¤ ì˜ˆì•½)
    â†“
[5] Binding ì‚¬ì´í´
    â”œâ”€ Permit í”ŒëŸ¬ê·¸ì¸ (ìŠ¹ì¸/ê±°ë¶€/ëŒ€ê¸°)
    â”œâ”€ PreBind í”ŒëŸ¬ê·¸ì¸
    â”œâ”€ Bind í”ŒëŸ¬ê·¸ì¸ (nodeName ì„¤ì •)
    â””â”€ PostBind í”ŒëŸ¬ê·¸ì¸
    â†“
[6] API Server ì—…ë°ì´íŠ¸
    â†“
[7] kubeletì´ Pod ì‹¤í–‰
```

---

## ğŸ¯ ìŠ¤ì¼€ì¤„ë§ í”„ë ˆì„ì›Œí¬

### í™•ì¥ í¬ì¸íŠ¸ (Extension Points)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Scheduling Cycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚
â”‚  â‘  QueueSort (í ì •ë ¬)                          â”‚
â”‚     â†“                                            â”‚
â”‚  â‘¡ PreFilter (ì‚¬ì „ í•„í„°ë§)                       â”‚
â”‚     â†“                                            â”‚
â”‚  â‘¢ Filter (í•„í„°ë§) â† â­ ê°€ì¥ ì¤‘ìš”               â”‚
â”‚     â†“                                            â”‚
â”‚  â‘£ PostFilter (ëª¨ë“  ë…¸ë“œ ì‹¤íŒ¨ ì‹œ)               â”‚
â”‚     â†“                                            â”‚
â”‚  â‘¤ PreScore (ì ìˆ˜ ê³„ì‚° ì¤€ë¹„)                    â”‚
â”‚     â†“                                            â”‚
â”‚  â‘¥ Score (ì ìˆ˜ ë§¤ê¸°ê¸°) â† â­ ê°€ì¥ ì¤‘ìš”           â”‚
â”‚     â†“                                            â”‚
â”‚  â‘¦ NormalizeScore (ì ìˆ˜ ì •ê·œí™”)                 â”‚
â”‚     â†“                                            â”‚
â”‚  â‘§ Reserve (ë¦¬ì†ŒìŠ¤ ì˜ˆì•½)                        â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Binding Cycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                  â”‚
â”‚  â‘¨ Permit (ìŠ¹ì¸/ê±°ë¶€/ëŒ€ê¸°)                      â”‚
â”‚     â†“                                            â”‚
â”‚  â‘© PreBind (ë°”ì¸ë”© ì „ ì¤€ë¹„)                     â”‚
â”‚     â†“                                            â”‚
â”‚  â‘ª Bind (nodeName ì„¤ì •) â† â­ ìµœì¢… ë°”ì¸ë”©        â”‚
â”‚     â†“                                            â”‚
â”‚  â‘« PostBind (ë°”ì¸ë”© í›„ ì‘ì—…)                    â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
````

### ì£¼ìš” í”ŒëŸ¬ê·¸ì¸ ì˜ˆì œ

#### NodeResourcesFit (Filter í”ŒëŸ¬ê·¸ì¸)

go

```go
// ì˜ì‚¬ ì½”ë“œ
func Filter(pod, node) bool {
    podCPU := pod.requests.cpu
    podMemory := pod.requests.memory
    
    availableCPU := node.allocatable.cpu - node.allocated.cpu
    availableMemory := node.allocatable.memory - node.allocated.memory
    
    if podCPU > availableCPU || podMemory > availableMemory {
        return false  // ë…¸ë“œ íƒˆë½
    }
    return true  // í†µê³¼
}
```

#### NodeResourcesBalancedAllocation (Score í”ŒëŸ¬ê·¸ì¸)

go

```go
// ë¦¬ì†ŒìŠ¤ ê· í˜• ì ìˆ˜ ê³„ì‚°
func Score(pod, node) int {
    cpuFraction := (node.allocated.cpu + pod.requests.cpu) / node.allocatable.cpu
    memoryFraction := (node.allocated.memory + pod.requests.memory) / node.allocatable.memory
    
    // ë‘ ë¦¬ì†ŒìŠ¤ì˜ ì‚¬ìš©ë¥  ì°¨ì´ê°€ ì‘ì„ìˆ˜ë¡ ë†’ì€ ì ìˆ˜
    variance := abs(cpuFraction - memoryFraction)
    score := 100 - (variance * 100)
    
    return score
}
```

---

## ğŸ† Pod ìš°ì„ ìˆœìœ„ì™€ ì„ ì  (Preemption)

### ì‹œë‚˜ë¦¬ì˜¤: ë¦¬ì†ŒìŠ¤ ë¶€ì¡±í•œ í´ëŸ¬ìŠ¤í„°

yaml

````yaml
# 1. PriorityClass ì •ì˜
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
value: 1000000
globalDefault: false
description: "Critical system pods"
---
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: low-priority
value: 1000
---

# 2. ë‚®ì€ ìš°ì„ ìˆœìœ„ Pod (ì´ë¯¸ ì‹¤í–‰ ì¤‘)
apiVersion: v1
kind: Pod
metadata:
  name: low-priority-pod
spec:
  priorityClassName: low-priority
  containers:
  - name: app
    image: nginx
    resources:
      requests:
        cpu: "1"
        memory: "2Gi"
---

# 3. ë†’ì€ ìš°ì„ ìˆœìœ„ Pod (ìƒˆë¡œ ìƒì„±)
apiVersion: v1
kind: Pod
metadata:
  name: high-priority-pod
spec:
  priorityClassName: high-priority
  containers:
  - name: critical-app
    image: nginx
    resources:
      requests:
        cpu: "1"
        memory: "2Gi"
```

### ì„ ì  í”Œë¡œìš°
```
[í´ëŸ¬ìŠ¤í„° ìƒíƒœ]
ë…¸ë“œA: CPU 4ì½”ì–´ ì¤‘ 3ì½”ì–´ ì‚¬ìš© (1ì½”ì–´ ë‚¨ìŒ)
  - low-priority-pod-1 (1ì½”ì–´)
  - low-priority-pod-2 (1ì½”ì–´)
  - low-priority-pod-3 (1ì½”ì–´)

[ì´ë²¤íŠ¸] high-priority-pod ìƒì„± (1ì½”ì–´ í•„ìš”)
    â†“
[Scheduler] Filter ë‹¨ê³„
    â”œâ”€ ëª¨ë“  ë…¸ë“œ ë¦¬ì†ŒìŠ¤ ë¶€ì¡± âŒ
    â””â”€ PostFilter í”ŒëŸ¬ê·¸ì¸ ì‹¤í–‰ (ì„ ì  ì‹œì‘)
    â†“
[ì„ ì  ì•Œê³ ë¦¬ì¦˜]
    â”œâ”€ ìš°ì„ ìˆœìœ„ ë¹„êµ: high (1000000) vs low (1000)
    â”œâ”€ í¬ìƒì ì„ íƒ: low-priority-pod-3
    â””â”€ Preemption ê²°ì •
    â†“
[Graceful Termination]
    â”œâ”€ low-priority-pod-3ì— SIGTERM ì „ì†¡
    â”œâ”€ terminationGracePeriodSeconds ëŒ€ê¸° (30ì´ˆ)
    â””â”€ Pod ì¢…ë£Œ
    â†“
[ë¦¬ì†ŒìŠ¤ í™•ë³´] ë…¸ë“œA: 2ì½”ì–´ ë‚¨ìŒ
    â†“
[Scheduler] high-priority-pod ë°°ì •
    â†“
[kubelet] high-priority-pod ì‹¤í–‰ âœ…
````

### ì´ë²¤íŠ¸ í™•ì¸

bash

````bash
$ kubectl describe pod low-priority-pod-3
Events:
  Type     Reason     Message
  ----     ------     -------
  Normal   Preempted  Preempted by default/high-priority-pod on node node-1

$ kubectl describe pod high-priority-pod
Events:
  Type     Reason               Message
  ----     ------               -------
  Normal   SuccessfulPreemption Preempted pod default/low-priority-pod-3
  Normal   Scheduled            Successfully assigned to node-1
```

---

# Part 2: ìŠ¤í† ë¦¬ì§€ (ê³µì‹ ë¬¸ì„œ ê¸°ë°˜ ëŒ€í­ ë³´ì™„)

---

## ğŸ“¦ ë³¼ë¥¨ íƒ€ì… ì™„ì „ ì •ë¦¬

### 1. ì¼ë°˜ ë³¼ë¥¨ (Volumes) - Pod ìˆ˜ëª… ì£¼ê¸° ì¢…ì†
```
Pod ìƒì„± â†’ ë³¼ë¥¨ ìƒì„± â†’ Pod ì‚­ì œ â†’ ë³¼ë¥¨ ì‚­ì œ ğŸ’¥
````

#### emptyDir (ê°€ì¥ ê¸°ë³¸)

yaml

````yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: cache
      mountPath: /cache
  - name: sidecar
    image: busybox
    command: ["/bin/sh", "-c", "tail -f /cache/access.log"]
    volumeMounts:
    - name: cache
      mountPath: /cache
  volumes:
  - name: cache
    emptyDir: {}  # ë¹ˆ ë””ë ‰í„°ë¦¬, Pod ì‚­ì œ ì‹œ ì‚¬ë¼ì§
```

**í”Œë¡œìš°:**
```
Pod ìƒì„± â†’ kubeletì´ ë…¸ë“œì— ì„ì‹œ ë””ë ‰í„°ë¦¬ ìƒì„±
         (/var/lib/kubelet/pods/<pod-uid>/volumes/kubernetes.io~empty-dir/cache)
         â†“
ì»¨í…Œì´ë„ˆ ì‹œì‘ â†’ ë‘ ì»¨í…Œì´ë„ˆ ëª¨ë‘ ê°™ì€ ë””ë ‰í„°ë¦¬ ë§ˆìš´íŠ¸
         â†“
ë°ì´í„° ê³µìœ  (ê°™ì€ Pod ë‚´ ì»¨í…Œì´ë„ˆ ê°„)
         â†“
Pod ì‚­ì œ â†’ ë””ë ‰í„°ë¦¬ ì‚­ì œ ğŸ’¥ (ë°ì´í„° ì†ì‹¤)
````

#### hostPath (ë…¸ë“œ íŒŒì¼ì‹œìŠ¤í…œ ì§ì ‘ ì ‘ê·¼)

yaml

````yaml
apiVersion: v1
kind: Pod
metadata:
  name: test-hostpath
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: host-logs
      mountPath: /var/log/app
  volumes:
  - name: host-logs
    hostPath:
      path: /var/log/containers  # ë…¸ë“œì˜ ì‹¤ì œ ê²½ë¡œ
      type: DirectoryOrCreate
```

**í”Œë¡œìš°:**
```
Pod ìƒì„± â†’ Schedulerê°€ ë…¸ë“œ ì„ íƒ (ì˜ˆ: node-1)
         â†“
kubelet â†’ ë…¸ë“œì˜ /var/log/containersë¥¼ ì»¨í…Œì´ë„ˆì— ë§ˆìš´íŠ¸
         â†“
ì»¨í…Œì´ë„ˆ â†’ ë…¸ë“œì˜ ì‹¤ì œ íŒŒì¼ ì‹œìŠ¤í…œì— ì§ì ‘ ì½ê¸°/ì“°ê¸°
         â†“
âš ï¸ ì£¼ì˜: ê°™ì€ Podê°€ ë‹¤ë¥¸ ë…¸ë“œë¡œ ì¬ìŠ¤ì¼€ì¤„ë˜ë©´ ë°ì´í„° ì†ì‹¤!
```

---

### 2. í¼ì‹œìŠ¤í„´íŠ¸ ë³¼ë¥¨ (Persistent Volumes) - ë…ë¦½ì  ìˆ˜ëª… ì£¼ê¸°
```
PV ìƒì„± â†’ PVC ìƒì„± â†’ Pod ì‚¬ìš© â†’ Pod ì‚­ì œ â†’ PV ìœ ì§€ âœ…
```

#### ì´ë¯¸ ì•ì—ì„œ ë‹¤ë£¬ ë‚´ìš©ì´ë¯€ë¡œ ìƒëµí•˜ê³ , ì¶”ê°€ ì„¸ë¶€ì‚¬í•­ë§Œ ë³´ì™„

---

## ğŸ­ í”„ë¡œì í‹°ë“œ ë³¼ë¥¨ (Projected Volumes)

### ê°œë…: ì—¬ëŸ¬ ë³¼ë¥¨ ì†ŒìŠ¤ë¥¼ í•˜ë‚˜ë¡œ í†µí•©
```
Secret + ConfigMap + ServiceAccount â†’ í•˜ë‚˜ì˜ ë””ë ‰í„°ë¦¬ë¡œ í”„ë¡œì ì…˜
````

### ì‚¬ìš© ì‚¬ë¡€: TLS ì¸ì¦ì„œ + ì•± ì„¤ì • í†µí•©

yaml

````yaml
# 1. ì†ŒìŠ¤ ìƒì„±
apiVersion: v1
kind: Secret
metadata:
  name: tls-secret
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi... (base64)
  tls.key: LS0tLS1CRUdJTi... (base64)
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  app.conf: |
    server {
      listen 443 ssl;
      ssl_certificate /certs/tls.crt;
      ssl_certificate_key /certs/tls.key;
    }
---

# 2. Projected Volumeìœ¼ë¡œ í†µí•©
apiVersion: v1
kind: Pod
metadata:
  name: web-server
spec:
  containers:
  - name: nginx
    image: nginx:1.21
    volumeMounts:
    - name: config-and-certs
      mountPath: /certs
      readOnly: true
  volumes:
  - name: config-and-certs
    projected:  # â­ ì—¬ëŸ¬ ì†ŒìŠ¤ í†µí•©
      sources:
      - secret:
          name: tls-secret
          items:
          - key: tls.crt
            path: tls.crt
          - key: tls.key
            path: tls.key
      - configMap:
          name: app-config
          items:
          - key: app.conf
            path: nginx.conf
      - serviceAccountToken:  # â­ ServiceAccount í† í°ë„ ì¶”ê°€
          path: token
          expirationSeconds: 3600
```

### í”Œë¡œìš°
```
Pod ìƒì„±
    â†“
kubeletì´ projected ë³¼ë¥¨ ì²˜ë¦¬
    â†“
    â”œâ”€ tls-secretì—ì„œ tls.crt, tls.key ì¶”ì¶œ
    â”œâ”€ app-configì—ì„œ nginx.conf ì¶”ì¶œ
    â””â”€ ServiceAccount í† í° ìƒì„± (1ì‹œê°„ TTL)
    â†“
ì„ì‹œ ë””ë ‰í„°ë¦¬ì— ëª¨ë‘ í†µí•©
    /certs/
      â”œâ”€ tls.crt        (from Secret)
      â”œâ”€ tls.key        (from Secret)
      â”œâ”€ nginx.conf     (from ConfigMap)
      â””â”€ token          (from SA)
    â†“
ì»¨í…Œì´ë„ˆì— ì½ê¸° ì „ìš©ìœ¼ë¡œ ë§ˆìš´íŠ¸
    â†“
nginx ì‹œì‘ â†’ /certs/nginx.conf ì½ê¸° â†’ TLS í™œì„±í™” âœ…
````

### ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸

bash

```bash
# ConfigMap ì—…ë°ì´íŠ¸
$ kubectl edit configmap app-config
# nginx.conf ë‚´ìš© ìˆ˜ì •

# ì•½ 60ì´ˆ í›„ ìë™ ë°˜ì˜!
$ kubectl exec web-server -- cat /certs/nginx.conf
# ìƒˆë¡œìš´ ë‚´ìš© í™•ì¸ âœ…
```

---

## âš¡ ì„ì‹œ ë³¼ë¥¨ (Ephemeral Volumes)

### 1. Generic Ephemeral Volumes (ë™ì  ìƒì„±)

yaml

````yaml
apiVersion: v1
kind: Pod
metadata:
  name: scratch-workspace
spec:
  containers:
  - name: builder
    image: golang:1.19
    volumeMounts:
    - name: scratch
      mountPath: /workspace
  volumes:
  - name: scratch
    ephemeral:  # â­ ì„ì‹œ ë³¼ë¥¨
      volumeClaimTemplate:
        spec:
          accessModes: [ "ReadWriteOnce" ]
          storageClassName: fast-ssd
          resources:
            requests:
              storage: 10Gi
```

### í”Œë¡œìš°
```
Pod ìƒì„±
    â†“
kubeletì´ ephemeral ë³¼ë¥¨ ê°ì§€
    â†“
ìë™ìœ¼ë¡œ PVC ìƒì„± (ì´ë¦„: <pod-name>-<volume-name>)
    â”œâ”€ PVC ì´ë¦„: scratch-workspace-scratch
    â”œâ”€ StorageClass: fast-ssd
    â””â”€ í¬ê¸°: 10Gi
    â†“
ë™ì  í”„ë¡œë¹„ì €ë‹ (StorageClass ê¸°ë°˜)
    â”œâ”€ AWS EBS ë³¼ë¥¨ ìƒì„± (10GB gp3)
    â””â”€ PV ìë™ ìƒì„±
    â†“
PVC â†” PV Binding
    â†“
ì»¨í…Œì´ë„ˆì— ë§ˆìš´íŠ¸ (/workspace)
    â†“
[ë¹Œë“œ ì‘ì—… ìˆ˜í–‰]
    â†“
Pod ì‚­ì œ
    â†“
â­ PVC ìë™ ì‚­ì œ â†’ PV ìë™ ì‚­ì œ (ReclaimPolicy: Delete)
    â†“
EBS ë³¼ë¥¨ ì‚­ì œ ğŸ’¥ (ì„ì‹œ ë°ì´í„°)
````

### í™•ì¸

bash

```bash
# Pod ì‹¤í–‰ ì¤‘
$ kubectl get pvc
NAME                          STATUS   VOLUME        CAPACITY
scratch-workspace-scratch     Bound    pvc-xyz123    10Gi

# Pod ì‚­ì œ í›„
$ kubectl delete pod scratch-workspace
$ kubectl get pvc
No resources found.  # â­ PVCë„ í•¨ê»˜ ì‚­ì œë¨!
```

---

### 2. CSI Ephemeral Volumes (ì¸ë¼ì¸ ë°©ì‹)

yaml

````yaml
apiVersion: v1
kind: Pod
metadata:
  name: secrets-store-inline
spec:
  containers:
  - name: app
    image: nginx
    volumeMounts:
    - name: secrets
      mountPath: /mnt/secrets
      readOnly: true
  volumes:
  - name: secrets
    csi:  # â­ CSI ë“œë¼ì´ë²„ ì§ì ‘ í˜¸ì¶œ
      driver: secrets-store.csi.k8s.io
      readOnly: true
      volumeAttributes:
        secretProviderClass: "aws-secrets"
```

### í”Œë¡œìš° (AWS Secrets Manager ì˜ˆì œ)
```
Pod ìƒì„±
    â†“
kubelet â†’ CSI Driver í˜¸ì¶œ (secrets-store.csi.k8s.io)
    â†“
CSI Driver â†’ AWS Secrets Manager API í˜¸ì¶œ
    â”œâ”€ SecretId: prod/db/password
    â””â”€ ì¸ì¦: IRSA (IAM Role for Service Account)
    â†“
ì‹œí¬ë¦¿ ë‹¤ìš´ë¡œë“œ â†’ ì„ì‹œ íŒŒì¼ ì‹œìŠ¤í…œì— ì €ì¥
    â†“
ì»¨í…Œì´ë„ˆì— ë§ˆìš´íŠ¸ (/mnt/secrets/)
    /mnt/secrets/
      â””â”€ db-password  (ë‚´ìš©: MySecurePassword123)
    â†“
ì• í”Œë¦¬ì¼€ì´ì…˜ â†’ íŒŒì¼ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ì½ê¸°
    â†“
Pod ì‚­ì œ â†’ ì„ì‹œ íŒŒì¼ ì‚­ì œ ğŸ’¥ (ì‹œí¬ë¦¿ ë…¸ì¶œ ë°©ì§€)
```

---

## ğŸ”„ í¼ì‹œìŠ¤í„´íŠ¸ ë³¼ë¥¨ ì‹¬í™” (Lifecycle)

### PV ìƒíƒœ ì „í™˜ ë‹¤ì´ì–´ê·¸ë¨
```
[PV ìƒì„±]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Available   â”‚ â† ì‚¬ìš© ê°€ëŠ¥, PVC ëŒ€ê¸° ì¤‘
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ PVC Binding
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Bound     â”‚ â† PVCì™€ 1:1 ì—°ê²°ë¨
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ PVC ì‚­ì œ
      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Released   â”‚ â† PVC ì—†ì–´ì¡Œì§€ë§Œ ë°ì´í„° ë‚¨ì•„ìˆìŒ
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€ ReclaimPolicy: Retain
      â”‚    â†“ (ìˆ˜ë™ ì •ë¦¬ í•„ìš”)
      â”‚  [ê´€ë¦¬ì ê°œì…] â†’ Delete PV â†’ Available (ì¬ì‚¬ìš©)
      â”‚
      â”œâ”€ ReclaimPolicy: Delete
      â”‚    â†“ (ìë™ ì‚­ì œ)
      â”‚  PV ì‚­ì œ â†’ ì™¸ë¶€ ìŠ¤í† ë¦¬ì§€ë„ ì‚­ì œ ğŸ’¥
      â”‚
      â””â”€ ReclaimPolicy: Recycle (Deprecated)
           â†“
         ë°ì´í„° ì‚­ì œ (rm -rf /volume/*)
           â†“
         Available (ì¬ì‚¬ìš© ê°€ëŠ¥)
````

### ReclaimPolicy ì‹œë‚˜ë¦¬ì˜¤

#### Retain (ë³´ì¡´)

yaml

````yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-important-data
spec:
  capacity:
    storage: 100Gi
  persistentVolumeReclaimPolicy: Retain  # â­ ë³´ì¡´
  nfs:
    server: 10.1.1.5
    path: /exports/important
```

**í”Œë¡œìš°:**
```
[ìƒíƒœ: Bound] PVC (app-data) â†” PV (pv-important-data)
    â†“
PVC ì‚­ì œ (kubectl delete pvc app-data)
    â†“
[ìƒíƒœ: Released]
  - PVëŠ” ì‚­ì œë˜ì§€ ì•ŠìŒ âœ…
  - NFS ë°ì´í„° ê·¸ëŒ€ë¡œ ë³´ì¡´ âœ…
  - í•˜ì§€ë§Œ ë‹¤ë¥¸ PVC ë°”ì¸ë”© ë¶ˆê°€ âš ï¸
    â†“
ê´€ë¦¬ì ìˆ˜ë™ ì‘ì—…:
  1. ë°ì´í„° ë°±ì—…
  2. ë°ì´í„° ì •ë¦¬ (í•„ìš”ì‹œ)
  3. PV ì‚­ì œ
  4. ìƒˆ PV ìƒì„± (ê°™ì€ NFS ê²½ë¡œ)
````

#### Delete (ì‚­ì œ)

yaml

````yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: ebs.csi.aws.com
reclaimPolicy: Delete  # â­ ê¸°ë³¸ê°’
```

**í”Œë¡œìš°:**
```
[ë™ì  í”„ë¡œë¹„ì €ë‹] PVC ìƒì„± â†’ PV ìë™ ìƒì„± (EBS ë³¼ë¥¨)
    â†“
[ìƒíƒœ: Bound] PVC â†” PV
    â†“
PVC ì‚­ì œ
    â†“
[PV ìë™ ì‚­ì œ íŠ¸ë¦¬ê±°]
    â”œâ”€ Kubernetes PV ê°ì²´ ì‚­ì œ
    â””â”€ CSI Driver í˜¸ì¶œ â†’ AWS EBS DeleteVolume API
    â†“
EBS ë³¼ë¥¨ ì‚­ì œ ğŸ’¥ (ë³µêµ¬ ë¶ˆê°€!)
````

---

## âš™ï¸ StorageClass ìƒì„¸

### Provisionerë³„ ì°¨ì´ì 

#### 1. AWS EBS CSI Driver

yaml

````yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ebs-gp3
provisioner: ebs.csi.aws.com
parameters:
  type: gp3  # SSD íƒ€ì…
  iopsPerGB: "50"
  throughput: "125"  # MB/s
  encrypted: "true"
  kmsKeyId: "arn:aws:kms:us-east-1:123456789012:key/abcd"
volumeBindingMode: WaitForFirstConsumer  # â­ ì¤‘ìš”!
allowVolumeExpansion: true
```

**WaitForFirstConsumer í”Œë¡œìš°:**
```
PVC ìƒì„± (10Gi, ebs-gp3)
    â†“
[PVC ìƒíƒœ: Pending] â† â­ ì•„ì§ PV ìƒì„± ì•ˆ í•¨!
    â†“
Pod ìƒì„± (PVC ì‚¬ìš©)
    â†“
Scheduler â†’ Podë¥¼ us-east-1a ë…¸ë“œì— í• ë‹¹
    â†“ â­ íŠ¸ë¦¬ê±°!
CSI Provisioner â†’ EBS ë³¼ë¥¨ì„ us-east-1aì— ìƒì„±
    â†“
PV ìƒì„± (pvc-xyz, availabilityZone: us-east-1a)
    â†“
PVC â†” PV Binding
    â†“
kubelet â†’ EBS ì–´íƒœì¹˜ â†’ ì»¨í…Œì´ë„ˆ ë§ˆìš´íŠ¸ âœ…
```

**ì™œ WaitForFirstConsumer?**
```
ë¬¸ì œ ìƒí™© (Immediate ëª¨ë“œ):
PVC ìƒì„± â†’ EBSë¥¼ us-east-1aì— ìƒì„±
Pod ìƒì„± â†’ Schedulerê°€ us-east-1b ë…¸ë“œì— í• ë‹¹
  â†“
âŒ EBSëŠ” ê°™ì€ AZì—ì„œë§Œ ì–´íƒœì¹˜ ê°€ëŠ¥!
  â†“
Pod Pending (FailedAttachVolume)

í•´ê²° (WaitForFirstConsumer):
Pod ìŠ¤ì¼€ì¤„ë§ í›„ â†’ Podê°€ ìˆëŠ” AZì— EBS ìƒì„± âœ…
````

---

#### 2. NFS Provisioner

yaml

````yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-client
provisioner: nfs-subdir-external-provisioner  # Helm chart
parameters:
  archiveOnDelete: "true"  # ì‚­ì œ ì‹œ ì•„ì¹´ì´ë¹™
volumeBindingMode: Immediate
reclaimPolicy: Retain
```

**í”Œë¡œìš°:**
```
PVC ìƒì„± (5Gi, nfs-client)
    â†“
NFS Provisioner (Pod) ê°ì§€
    â†“
NFS ì„œë²„ì— ì„œë¸Œë””ë ‰í„°ë¦¬ ìƒì„±
    /nfs-exports/
      â””â”€ default-my-pvc-pvc-xyz/  # ìë™ ìƒì„±
    â†“
PV ìƒì„± (nfs íƒ€ì…, path: /default-my-pvc-pvc-xyz)
    â†“
PVC â†” PV Binding
    â†“
Pod â†’ NFS ë§ˆìš´íŠ¸ âœ…
    â†“
PVC ì‚­ì œ
    â†“
archiveOnDelete: true
    â†“
ë””ë ‰í„°ë¦¬ ì´ë¦„ ë³€ê²½ (ì•„ì¹´ì´ë¹™)
    /nfs-exports/
      â””â”€ archived-default-my-pvc-pvc-xyz-20240115/
````

---

## ğŸ“ ìŠ¤í† ë¦¬ì§€ ì„ íƒ ê°€ì´ë“œ

### ì‚¬ìš© ì‚¬ë¡€ë³„ ì¶”ì²œ

|ì‚¬ìš© ì‚¬ë¡€|ì¶”ì²œ ë³¼ë¥¨ íƒ€ì…|ì´ìœ |
|---|---|---|
|ë¡œê·¸ ìˆ˜ì§‘ (ê°™ì€ Pod ë‚´)|`emptyDir`|ê°„ë‹¨, Pod ì¢…ë£Œ ì‹œ ìë™ ì •ë¦¬|
|ìºì‹œ ë°ì´í„°|`emptyDir` (ë©”ëª¨ë¦¬ ë°±ì—”ë“œ)|ì´ˆê³ ì†, íœ˜ë°œì„± OK|
|ë¹Œë“œ ì‘ì—… ê³µê°„|Generic Ephemeral Volume|ë™ì  ìƒì„±, ìë™ ì •ë¦¬|
|ì„¤ì • + ì¸ì¦ì„œ í†µí•©|Projected Volume|ì—¬ëŸ¬ ì†ŒìŠ¤ í†µí•©, ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸|
|ë°ì´í„°ë² ì´ìŠ¤|PVC + StatefulSet|ì˜êµ¬ ë³´ì¡´, Podë³„ ë…ë¦½ ìŠ¤í† ë¦¬ì§€|
|ê³µìœ  íŒŒì¼ ì‹œìŠ¤í…œ|PVC (ReadWriteMany) + NFS|ì—¬ëŸ¬ Pod ë™ì‹œ ì ‘ê·¼|
|ì™¸ë¶€ ì‹œí¬ë¦¿ (Vault)|CSI Ephemeral Volume|ë³´ì•ˆ, ì„ì‹œ ë§ˆìš´íŠ¸|

---

## ğŸ” íŠ¸ëŸ¬ë¸”ìŠˆíŒ… í”Œë¡œìš°

### ë¬¸ì œ 1: PVCê°€ Pending ìƒíƒœ

bash

````bash
$ kubectl get pvc
NAME       STATUS    VOLUME   STORAGECLASS
app-data   Pending   -        fast-ssd

# ì›ì¸ ì§„ë‹¨
$ kubectl describe pvc app-data
Events:
  Type     Reason              Message
  ----     ------              -------
  Warning  ProvisioningFailed  Failed to provision volume: 
                               no volume plugin matched
```

**í•´ê²° í”Œë¡œìš°:**
```
1. StorageClass í™•ì¸
   $ kubectl get storageclass fast-ssd
   âŒ Error: storageclass.storage.k8s.io "fast-ssd" not found
   
   í•´ê²°: StorageClass ìƒì„±
   $ kubectl apply -f storageclass.yaml

2. CSI Driver í™•ì¸
   $ kubectl get pods -n kube-system | grep ebs-csi
   âŒ No resources found
   
   í•´ê²°: CSI Driver ì„¤ì¹˜
   $ helm install aws-ebs-csi-driver ...

3. volumeBindingMode í™•ì¸
   $ kubectl get sc fast-ssd -o yaml | grep volumeBindingMode
   volumeBindingMode: WaitForFirstConsumer
   
   ì›ì¸: Podê°€ ì•„ì§ ìƒì„±ë˜ì§€ ì•ŠìŒ
   í•´ê²°: Pod ìƒì„±í•˜ë©´ ìë™ í”„ë¡œë¹„ì €ë‹ë¨
```

---

## ğŸ“š í•µì‹¬ ìš”ì•½

### ìŠ¤ì¼€ì¤„ë§
```
Pod ìƒì„± â†’ Scheduler í â†’ ìŠ¤ì¼€ì¤„ë§ ì‚¬ì´í´ (Filter + Score) â†’ Binding ì‚¬ì´í´ â†’ kubelet ì‹¤í–‰
```

### ìŠ¤í† ë¦¬ì§€
```
ì¼ë°˜ ë³¼ë¥¨: Pod ìˆ˜ëª… ì£¼ê¸° ì¢…ì†, ê°„ë‹¨í•œ ê³µìœ /ìºì‹œ
í”„ë¡œì í‹°ë“œ: ì—¬ëŸ¬ ì†ŒìŠ¤ í†µí•©, ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
ì„ì‹œ ë³¼ë¥¨: ë™ì  ìƒì„±, ìë™ ì •ë¦¬
í¼ì‹œìŠ¤í„´íŠ¸: ë…ë¦½ ìˆ˜ëª… ì£¼ê¸°, ì˜êµ¬ ë³´ì¡´
````


### ğŸ“ ìŠ¤ì¼€ì¤„ë§ & ìŠ¤í† ë¦¬ì§€ ìµœì¢… ìš”ì•½

- **ìŠ¤ì¼€ì¤„ë§ (Podê°€ ë…¸ë“œë¥¼ ì°¾ëŠ” ë²•)**
    
    1. `ReplicaSet` ë“±ì´ `nodeName`ì´ ë¹„ì–´ìˆëŠ” Podë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        
    2. `kube-scheduler`ê°€ ì´ Podë¥¼ ë°œê²¬í•©ë‹ˆë‹¤.
        
    3. **í•„í„°ë§:** Podì˜ ìš”êµ¬ì¡°ê±´(ë¦¬ì†ŒìŠ¤, `nodeSelector`, `Taint`/`Toleration` ë“±)ì„ ë§Œì¡± ëª» í•˜ëŠ” ë…¸ë“œë¥¼ ëª¨ë‘ íƒˆë½ì‹œí‚µë‹ˆë‹¤.
        
    4. **ìŠ¤ì½”ì–´ë§:** ë‚¨ì€ í›„ë³´ ë…¸ë“œë“¤ì—ê²Œ ì ìˆ˜ë¥¼ ë§¤ê¹ë‹ˆë‹¤. (ì˜ˆ: ë¦¬ì†ŒìŠ¤ ì—¬ìœ ê°€ ë§ìœ¼ë©´ ë†’ì€ ì ìˆ˜, `Affinity`ê°€ ë§ìœ¼ë©´ ë†’ì€ ì ìˆ˜)
        
    5. **ë°”ì¸ë”©:** 1ë“± ë…¸ë“œë¥¼ Podì˜ `nodeName`ì— ê¸°ë¡í•©ë‹ˆë‹¤.
        
    6. í•´ë‹¹ ë…¸ë“œì˜ `kubelet`ì´ Podë¥¼ ë°œê²¬í•˜ê³  ì»¨í…Œì´ë„ˆë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
        
- **ìŠ¤í† ë¦¬ì§€ (ë°ì´í„°ê°€ ì‚´ì•„ë‚¨ëŠ” ë²•)**
    
    1. **ì¶”ìƒí™”:** ê°œë°œìëŠ” "10GB í•„ìš”"ë¼ëŠ” **PVC(ìš”ì²­ì„œ)**ë§Œ ì‘ì„±í•©ë‹ˆë‹¤. ê´€ë¦¬ìëŠ” "NFS 50GBì§œë¦¬"ë¼ëŠ” **PV(ê¸ˆê³ )**ë¥¼ ì¤€ë¹„í•©ë‹ˆë‹¤.
        
    2. **ì •ì  í”„ë¡œë¹„ì €ë‹:** ê´€ë¦¬ìê°€ PV(ê¸ˆê³ )ë¥¼ **ìˆ˜ë™ìœ¼ë¡œ** ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘¡ë‹ˆë‹¤. PVC(ìš”ì²­ì„œ)ê°€ ë“¤ì–´ì˜¤ë©´ ì¿ ë²„ë„¤í‹°ìŠ¤ê°€ ì¡°ê±´ì´ ë§ëŠ” PVì™€ **ë°”ì¸ë”©**í•©ë‹ˆë‹¤.
        
    3. **ë™ì  í”„ë¡œë¹„ì €ë‹:** ê´€ë¦¬ìê°€ **StorageClass(ê¸ˆê³  ì œì‘ ì„¤ëª…ì„œ)**ë¥¼ ë¯¸ë¦¬ ë§Œë“¤ì–´ ë‘¡ë‹ˆë‹¤. PVCê°€ "ì´ ì„¤ëª…ì„œëŒ€ë¡œ ë§Œë“¤ì–´ì£¼ì„¸ìš”"ë¼ê³  ìš”ì²­í•˜ë©´, CSI ë“œë¼ì´ë²„ê°€ PV(ê¸ˆê³ )ë¥¼ **ìë™ìœ¼ë¡œ** ìƒì„±í•˜ê³  ì¦‰ì‹œ ë°”ì¸ë”©í•©ë‹ˆë‹¤.
        
    4. **StatefulSet:** `volumeClaimTemplates`ë¼ëŠ” 'PVC í…œí”Œë¦¿'ì„ ì‚¬ìš©í•˜ì—¬, `mysql-0` Podë¥¼ ìœ„í•œ `data-mysql-0` PVC, `mysql-1` Podë¥¼ ìœ„í•œ `data-mysql-1` PVCë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê³  1:1ë¡œ ê³ ì •ì‹œì¼œ ë°ì´í„° ì˜ì†ì„±ì„ ë³´ì¥í•©ë‹ˆë‹¤.

---

**ì‘ì„±ì¼**: 2025-11-07
